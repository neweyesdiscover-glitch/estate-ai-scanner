<!-- frontend/index.html
     ✅ Company login + camera + gallery + local history + shared TEAM history
-->

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estate AI Scanner</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 6px; }
    .sub { margin: 0 0 16px; color: #555; }

    .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin: 10px 0 18px; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button.primary { background: #2b7cff; color: #fff; border-color: #2b7cff; font-weight: 700; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .grid { display: grid; grid-template-columns: 360px 1fr; gap: 18px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; background: #fff; }
    .card h3 { margin: 0 0 10px; }

    #preview {
      width: 100%;
      max-height: 520px;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid #eee;
      display: none;
    }

    .status { margin: 8px 0 0; color: #666; font-size: 13px; }
    .ok { color: #0a7a0a; font-weight: 700; }
    .err { color: #b00020; font-weight: 700; }

    .resultLine { margin: 6px 0; line-height: 1.25; }
    .label { font-weight: 800; }

    .list { display: flex; flex-direction: column; gap: 10px; }
    .itemRow {
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 10px;
      align-items: center;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 8px;
      cursor: pointer;
    }
    .itemRow:hover { background: #fafafa; }
    .thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }
    .meta { font-size: 13px; color: #444; }
    .meta .title { font-weight: 800; color: #111; margin-bottom: 2px; }
    .meta .time { color: #666; font-size: 12px; }

    .small { font-size: 12px; color: #666; margin-top: 10px; }

    /* Login overlay */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.55);
      display: none; align-items: center; justify-content: center; padding: 20px;
    }
    .modal {
      width: 100%; max-width: 420px; background: #fff; border-radius: 14px; padding: 16px; border: 1px solid #ddd;
    }
    .modal h2 { margin: 0 0 8px; }
    .row { display: grid; gap: 8px; margin-top: 10px; }
    input {
      padding: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 14px; width: 100%;
    }
    .tabs { display: flex; gap: 8px; margin-top: 8px; }
    .tab { padding: 8px 10px; border-radius: 10px; border: 1px solid #ddd; cursor: pointer; }
    .tab.active { background: #2b7cff; border-color: #2b7cff; color: #fff; font-weight: 700; }
  </style>
</head>

<body>
  <h1>Estate AI Scanner</h1>
  <p class="sub">Company login required. Snap a photo, identify the item, and get an estimate.</p>

  <!-- Login status -->
  <div class="controls">
    <div id="whoami" class="status" style="flex:1;"></div>
    <button id="logoutBtn" onclick="logout()" style="display:none;">Logout</button>
  </div>

  <!-- Hidden inputs -->
  <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none" />
  <input id="galleryInput" type="file" accept="image/*" style="display:none" />

  <div class="controls">
    <button onclick="openCamera()">Use Camera</button>
    <button onclick="openGallery()">Choose From Photos</button>
    <button id="analyzeBtn" class="primary" onclick="analyze()">Analyze</button>
    <button onclick="refreshTeamHistory()">Refresh Team History</button>
    <button onclick="clearLocalHistory()">Clear Local History</button>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Preview</h3>
      <img id="preview" alt="Preview" />
      <div id="previewHint" class="status">Select a photo to begin.</div>
      <div class="small">Tip: On phones, “Use Camera” opens the rear camera.</div>
    </div>

    <div class="card">
      <h3>Result</h3>
      <div id="status" class="status"></div>
      <div id="result"></div>
    </div>

    <div class="card">
      <h3>Team History (shared)</h3>
      <div id="teamHistory" class="list"></div>
      <div id="teamEmpty" class="status">No team scans yet.</div>
    </div>

    <div class="card">
      <h3>Local History (this device)</h3>
      <div id="localHistory" class="list"></div>
      <div id="localEmpty" class="status">No local scans yet.</div>
    </div>
  </div>

  <!-- Login overlay -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <h2>Company Login</h2>
      <div class="status" style="margin:0;">Use your company name + passcode.</div>

      <div class="tabs">
        <div id="tabLogin" class="tab active" onclick="setMode('login')">Login</div>
        <div id="tabSignup" class="tab" onclick="setMode('signup')">Create Company</div>
      </div>

      <div class="row">
        <input id="companyName" placeholder="Company name (e.g., Smith Estate Sales)" />
        <input id="passcode" placeholder="Passcode (share with your staff)" type="password" />
        <button class="primary" onclick="submitAuth()" id="authBtn">Login</button>
        <div id="authStatus" class="status"></div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Elements
    // =========================
    const cameraInput = document.getElementById("cameraInput");
    const galleryInput = document.getElementById("galleryInput");
    const preview = document.getElementById("preview");
    const previewHint = document.getElementById("previewHint");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const analyzeBtn = document.getElementById("analyzeBtn");

    const whoamiEl = document.getElementById("whoami");
    const logoutBtn = document.getElementById("logoutBtn");

    const overlay = document.getElementById("overlay");
    const authStatus = document.getElementById("authStatus");
    const companyName = document.getElementById("companyName");
    const passcode = document.getElementById("passcode");
    const authBtn = document.getElementById("authBtn");
    const tabLogin = document.getElementById("tabLogin");
    const tabSignup = document.getElementById("tabSignup");

    const teamHistoryEl = document.getElementById("teamHistory");
    const teamEmptyEl = document.getElementById("teamEmpty");
    const localHistoryEl = document.getElementById("localHistory");
    const localEmptyEl = document.getElementById("localEmpty");

    // =========================
    // State
    // =========================
    let authMode = "login"; // or "signup"
    let selectedFile = null;
    let selectedDataUrl = null;
    let lastObjectUrl = null;

    const LOCAL_KEY = "estate_ai_local_history_v2";
    const LOCAL_LIMIT = 25;

    // =========================
    // Helpers
    // =========================
    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }
    function stripCodeFences(s) { return String(s ?? "").replace(/```json|```/gi, "").trim(); }
    function nowIso() { return new Date().toISOString(); }
    function formatTime(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso; } }

    async function api(path, options = {}) {
      // IMPORTANT: include cookies for session login
      const res = await fetch(path, { credentials: "include", ...options });
      const text = await res.text();
      let data = null;
      try { data = JSON.parse(stripCodeFences(text)); } catch { data = text; }
      if (!res.ok) {
        const msg = (data && data.detail) ? data.detail : text;
        throw new Error(`HTTP ${res.status}: ${msg}`);
      }
      return data;
    }

    // =========================
    // Auth UI
    // =========================
    function setMode(mode) {
      authMode = mode;
      authStatus.textContent = "";
      if (mode === "login") {
        tabLogin.classList.add("active"); tabSignup.classList.remove("active");
        authBtn.textContent = "Login";
      } else {
        tabSignup.classList.add("active"); tabLogin.classList.remove("active");
        authBtn.textContent = "Create Company";
      }
    }

    async function checkLogin() {
      try {
        const me = await api("/me");
        if (me.logged_in) {
          overlay.style.display = "none";
          whoamiEl.innerHTML = `<span class="ok">Logged in:</span> ${escapeHtml(me.company.name)}`;
          logoutBtn.style.display = "inline-block";
          await refreshTeamHistory();
        } else {
          overlay.style.display = "flex";
          whoamiEl.textContent = "Not logged in";
          logoutBtn.style.display = "none";
        }
      } catch (e) {
        overlay.style.display = "flex";
        whoamiEl.innerHTML = `<span class="err">Login required</span>`;
      }
    }

    async function submitAuth() {
      authStatus.textContent = "Working…";
      try {
        const payload = {
          name: companyName.value.trim(),
          passcode: passcode.value.trim()
        };
        if (!payload.name || !payload.passcode) {
          authStatus.innerHTML = `<span class="err">Enter company name + passcode.</span>`;
          return;
        }

        if (authMode === "signup") {
          await api("/signup-company", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
        } else {
          await api("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
        }

        authStatus.innerHTML = `<span class="ok">Success ✅</span>`;
        await checkLogin();
      } catch (e) {
        authStatus.innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`;
      }
    }

    async function logout() {
      try { await api("/logout", { method: "POST" }); } catch {}
      overlay.style.display = "flex";
      whoamiEl.textContent = "Not logged in";
      logoutBtn.style.display = "none";
    }

    // =========================
    // File selection
    // =========================
    function openCamera() { cameraInput.value = ""; cameraInput.click(); }
    function openGallery() { galleryInput.value = ""; galleryInput.click(); }

    function handleFileSelect(file) {
      if (!file) return;

      selectedFile = file;
      selectedDataUrl = null;

      statusEl.textContent = "";
      resultEl.innerHTML = "";

      analyzeBtn.disabled = true;
      previewHint.textContent = "Loading image…";

      if (lastObjectUrl) URL.revokeObjectURL(lastObjectUrl);
      lastObjectUrl = URL.createObjectURL(file);
      preview.src = lastObjectUrl;
      preview.style.display = "block";

      const reader = new FileReader();
      reader.onload = () => {
        selectedDataUrl = reader.result;
        previewHint.textContent = "Ready to analyze.";
        analyzeBtn.disabled = false;
      };
      reader.onerror = () => {
        previewHint.textContent = "Could not read image.";
        analyzeBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }

    cameraInput.addEventListener("change", () => handleFileSelect(cameraInput.files?.[0]));
    galleryInput.addEventListener("change", () => handleFileSelect(galleryInput.files?.[0]));

    // =========================
    // Result rendering
    // =========================
    function renderResult(data) {
      if (!data || typeof data !== "object") {
        resultEl.innerHTML = `<pre>${escapeHtml(String(data))}</pre>`;
        return;
      }

      if (data.error) {
        statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(data.error)}`;
        if (data.raw) resultEl.innerHTML = `<pre>${escapeHtml(data.raw)}</pre>`;
        return;
      }

      const kw = Array.isArray(data.keywords_for_listing)
        ? data.keywords_for_listing.join(", ")
        : (data.keywords_for_listing ?? "");

      const sources = Array.isArray(data.pricing_sources)
        ? data.pricing_sources
        : (typeof data.pricing_sources === "string" && data.pricing_sources.trim()
            ? data.pricing_sources.split(",").map(s => s.trim()).filter(Boolean)
            : []);

      resultEl.innerHTML = `
        <div class="resultLine"><span class="label">Item:</span> ${escapeHtml(data.item_name)}</div>
        <div class="resultLine"><span class="label">Brand/Origin:</span> ${escapeHtml(data.brand_or_origin)}</div>
        <div class="resultLine"><span class="label">Estimated Value Range:</span> ${escapeHtml(data.estimated_value_range)}</div>
        <div class="resultLine"><span class="label">Suggested Listing Price:</span> ${escapeHtml(data.suggested_listing_price)}</div>
        <div class="resultLine"><span class="label">Condition:</span> ${escapeHtml(data.condition_assumptions)}</div>
        <div class="resultLine"><span class="label">Keywords:</span> ${escapeHtml(kw)}</div>
        ${sources.length ? `
          <div class="resultLine" style="margin-top:10px;">
            <span class="label">Pricing Sources:</span>
            <ul>${sources.map(s => `<li>${escapeHtml(s)}</li>`).join("")}</ul>
          </div>
        ` : ""}
      `;
    }

    // =========================
    // Local history (device)
    // =========================
    function readLocal() {
      try { return JSON.parse(localStorage.getItem(LOCAL_KEY) || "[]"); } catch { return []; }
    }
    function writeLocal(items) {
      localStorage.setItem(LOCAL_KEY, JSON.stringify(items));
    }
    function addLocal(entry) {
      const items = readLocal();
      items.unshift(entry);
      writeLocal(items.slice(0, LOCAL_LIMIT));
      renderLocal();
    }
    function clearLocalHistory() {
      localStorage.removeItem(LOCAL_KEY);
      renderLocal();
    }
    function renderLocal() {
      const items = readLocal();
      localHistoryEl.innerHTML = "";
      if (!items.length) { localEmptyEl.style.display = "block"; return; }
      localEmptyEl.style.display = "none";

      items.forEach((item) => {
        const title = item?.result?.item_name || "Unknown item";
        const time = item?.created_at ? formatTime(item.created_at) : "";
        const range = item?.result?.estimated_value_range || "";
        const price = item?.result?.suggested_listing_price || "";

        const div = document.createElement("div");
        div.className = "itemRow";
        div.onclick = () => {
          selectedFile = null;
          selectedDataUrl = item.image_data_url || null;
          if (selectedDataUrl) { preview.src = selectedDataUrl; preview.style.display = "block"; }
          statusEl.innerHTML = `<span class="ok">Loaded ✅</span>`;
          renderResult(item.result);
        };

        div.innerHTML = `
          <img class="thumb" src="${escapeHtml(item.image_data_url || "")}" alt="thumb" />
          <div class="meta">
            <div class="title">${escapeHtml(title)}</div>
            <div>${escapeHtml(range)} ${price ? " • " + escapeHtml(price) : ""}</div>
            <div class="time">${escapeHtml(time)}</div>
          </div>
        `;
        localHistoryEl.appendChild(div);
      });
    }

    // =========================
    // Team history (server)
    // =========================
    async function refreshTeamHistory() {
      try {
        const payload = await api("/history?limit=50");
        const items = payload.items || [];

        teamHistoryEl.innerHTML = "";
        if (!items.length) { teamEmptyEl.style.display = "block"; return; }
        teamEmptyEl.style.display = "none";

        items.forEach((item) => {
          const title = item?.result?.item_name || "Unknown item";
          const time = item?.created_at ? formatTime(item.created_at) : "";
          const range = item?.result?.estimated_value_range || "";
          const price = item?.result?.suggested_listing_price || "";
          const img = item.image_url;

          const div = document.createElement("div");
          div.className = "itemRow";
          div.onclick = () => {
            // Load server image
            preview.src = img;
            preview.style.display = "block";
            previewHint.textContent = "Loaded from team history.";
            statusEl.innerHTML = `<span class="ok">Loaded ✅</span>`;
            renderResult(item.result);
          };

          div.innerHTML = `
            <img class="thumb" src="${escapeHtml(img)}" alt="thumb" />
            <div class="meta">
              <div class="title">${escapeHtml(title)}</div>
              <div>${escapeHtml(range)} ${price ? " • " + escapeHtml(price) : ""}</div>
              <div class="time">${escapeHtml(time)}</div>
            </div>
          `;
          teamHistoryEl.appendChild(div);
        });

      } catch (e) {
        teamEmptyEl.style.display = "block";
        teamEmptyEl.innerHTML = `<span class="err">Team history unavailable:</span> ${escapeHtml(e.message)}`;
      }
    }

    // =========================
    // Analyze (requires login)
    // =========================
    async function analyze() {
      if (!selectedFile) {
        statusEl.innerHTML = `<span class="err">Select a photo first.</span>`;
        return;
      }
      if (!selectedDataUrl) {
        statusEl.innerHTML = `<span class="err">Please wait—image still loading.</span>`;
        return;
      }

      analyzeBtn.disabled = true;
      statusEl.textContent = "Analyzing…";
      resultEl.innerHTML = "";

      const formData = new FormData();
      formData.append("file", selectedFile);

      try {
        const res = await fetch("/analyze-image", {
          method: "POST",
          body: formData,
          credentials: "include" // IMPORTANT for session cookie
        });

        const text = await res.text();
        const cleaned = stripCodeFences(text);
        let data;
        try { data = JSON.parse(cleaned); } catch { data = { error: "Could not parse JSON", raw: text }; }

        if (!res.ok) {
          const msg = (data && data.detail) ? data.detail : text;
          throw new Error(`HTTP ${res.status}: ${msg}`);
        }

        if (data?.error) {
          statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(data.error)}`;
          renderResult(data);
          return;
        }

        statusEl.innerHTML = `<span class="ok">Done ✅</span>`;
        renderResult(data);

        // Save to local device history
        addLocal({ created_at: nowIso(), image_data_url: selectedDataUrl, result: data });

        // Refresh team history
        await refreshTeamHistory();

      } catch (e) {
        // If not logged in, show login overlay
        if (String(e.message).includes("401")) {
          overlay.style.display = "flex";
        }
        statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(e.message)}`;
      } finally {
        analyzeBtn.disabled = false;
      }
    }

    // =========================
    // Init
    // =========================
    renderLocal();
    setMode("login");
    checkLogin();
  </script>
</body>
</html>
