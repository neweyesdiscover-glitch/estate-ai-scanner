<!-- frontend/index.html
     ✅ Estate AI Scanner
     - Single/Bundle vs Multi-item (max 8)
     - Multiple photos of one item (add detail photos)
     - Tips: what_to_check
     - Follow-up questions + Refine
     - Team history selectable + highlight + scroll
     - Local history text-only (no storage quota issues)
-->

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estate AI Scanner</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 6px; }
    .sub { margin: 0 0 16px; color: #555; }

    .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin: 10px 0 18px; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button.primary { background: #2b7cff; color: #fff; border-color: #2b7cff; font-weight: 700; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .modeBox {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 8px 10px;
      background: #fafafa;
      font-size: 13px;
    }
    .modeBox label { display: inline-flex; gap: 6px; align-items: center; cursor: pointer; }
    .modeNote { font-size: 12px; color: #666; margin-left: 6px; }

    .grid { display: grid; grid-template-columns: 360px 1fr; gap: 18px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; background: #fff; }
    .card h3 { margin: 0 0 10px; }

    .previewStrip { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .previewThumb {
      width: 72px; height: 72px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #eee;
      background: #f7f7f7;
    }

    #preview {
      width: 100%;
      max-height: 520px;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid #eee;
      display: none;
    }

    .status { margin: 8px 0 0; color: #666; font-size: 13px; }
    .ok { color: #0a7a0a; font-weight: 700; }
    .err { color: #b00020; font-weight: 700; }

    .resultLine { margin: 6px 0; line-height: 1.25; }
    .label { font-weight: 800; }

    .historyList { display: flex; flex-direction: column; gap: 10px; }
    .historyItem {
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 10px;
      align-items: center;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 8px;
      cursor: pointer;
    }
    .historyItem:hover { background: #fafafa; }

    .thumb {
      width: 72px; height: 72px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #eee;
      display: block;
      background: #f7f7f7;
      pointer-events: none;
    }
    .thumbPlaceholder {
      width: 72px; height: 72px;
      border-radius: 8px;
      border: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f7f7f7;
      color: #777;
      font-size: 12px;
      user-select: none;
      pointer-events: none;
    }

    .historyMeta { font-size: 13px; color: #444; }
    .historyMeta .title { font-weight: 800; color: #111; margin-bottom: 2px; }
    .historyMeta .time { color: #666; font-size: 12px; }

    .badge {
      display: inline-block;
      font-size: 11px;
      color: #2b7cff;
      background: rgba(43, 124, 255, 0.10);
      border: 1px solid rgba(43, 124, 255, 0.25);
      padding: 2px 6px;
      border-radius: 999px;
      margin-top: 6px;
    }

    .historyItem.selected {
      border-color: #2b7cff;
      box-shadow: 0 0 0 2px rgba(43, 124, 255, 0.18);
      background: #f4f8ff;
    }

    .confWrap { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin: 10px 0 6px; }
    .confPill {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 12px;
      border: 1px solid #ddd;
      background: #f7f7f7;
      color: #333;
    }
    .confPill strong { font-weight: 800; }
    .confHigh { border-color: rgba(10, 122, 10, 0.35); background: rgba(10, 122, 10, 0.08); color: #0a7a0a; }
    .confMed  { border-color: rgba(176, 112, 0, 0.35); background: rgba(176, 112, 0, 0.08); color: #7a4a00; }
    .confLow  { border-color: rgba(176, 0, 32, 0.30); background: rgba(176, 0, 32, 0.06); color: #b00020; }

    .tipBox {
      font-size: 12px;
      color: #555;
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      margin: 10px 0 0;
    }
    .tipBox ul { margin: 6px 0 0 18px; }

    .qaBox { margin-top: 12px; }
    .qaItem { border: 1px solid #eee; border-radius: 10px; padding: 10px; margin-top: 8px; }
    .qaQ { font-weight: 800; margin-bottom: 6px; }
    .qaWhy { color: #666; font-size: 12px; margin-top: 6px; }
    .qaBtns { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
    .qaBtns button { padding: 8px 10px; border-radius: 10px; font-size: 12px; }
    .qaBtns button.selected { border-color: #2b7cff; box-shadow: 0 0 0 2px rgba(43, 124, 255, 0.15); background: #f4f8ff; }

    .sectionTitle { margin-top: 14px; font-weight: 900; }
    .miniCard {
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      margin-top: 8px;
      cursor: pointer;
      background: #fff;
    }
    .miniCard:hover { background: #fafafa; }
    .miniCard.selected { border-color: #2b7cff; background: #f4f8ff; }
    .miniTitle { font-weight: 900; margin-bottom: 4px; }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #f7f7f7;
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0 0;
    }

    .small { font-size: 12px; color: #666; margin-top: 10px; }
  </style>
</head>

<body>
  <h1>Estate AI Scanner</h1>
  <p class="sub" id="subtitle">Snap a photo, identify the item(s), and get an estimate.</p>

  <!-- Capture inputs -->
  <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none" />
  <input id="galleryInput" type="file" accept="image/*" style="display:none" />
  <input id="extraInput" type="file" accept="image/*" style="display:none" />

  <div class="controls">
    <button onclick="openCamera()">Use Camera</button>
    <button onclick="openGallery()">Choose From Photos</button>
    <button onclick="addDetailPhoto()">Add Detail Photo</button>

    <span class="modeBox">
      <span style="font-weight:800;">Analyze as:</span>
      <label><input type="radio" name="mode" value="single" checked /> Single / Bundle</label>
      <label><input type="radio" name="mode" value="multi" /> Multiple items</label>
      <span class="modeNote">(multi max 8)</span>
    </span>

    <button id="analyzeBtn" class="primary" onclick="analyze()">Analyze</button>
    <button onclick="refreshTeamHistory()">Refresh Team History</button>
    <button onclick="clearLocalHistory()">Clear Local History</button>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Preview</h3>
      <img id="preview" alt="Preview" />
      <div id="previewHint" class="status">Select a photo to begin.</div>
      <div id="previewStrip" class="previewStrip"></div>

      <div class="small">
        Tip: For antiques/crystal/china, add a close-up of the backstamp/marking. If results miss items or are unclear, take a closer photo with better lighting.
      </div>
    </div>

    <div class="card">
      <h3>Result</h3>
      <div id="status" class="status"></div>
      <div id="result"></div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <h3>Team History (shared)</h3>
      <div id="teamHistory" class="historyList"></div>
      <div id="teamEmpty" class="status">No team scans yet.</div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <h3>Local History (this device)</h3>
      <div id="history" class="historyList"></div>
      <div id="historyEmpty" class="status">No local scans saved yet.</div>
      <div class="small">Local history stores results only (no photos) to avoid storage limits.</div>
    </div>
  </div>

  <script>
    const cameraInput = document.getElementById("cameraInput");
    const galleryInput = document.getElementById("galleryInput");
    const extraInput = document.getElementById("extraInput");

    const preview = document.getElementById("preview");
    const previewHint = document.getElementById("previewHint");
    const previewStrip = document.getElementById("previewStrip");

    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const analyzeBtn = document.getElementById("analyzeBtn");

    const historyEl = document.getElementById("history");
    const historyEmptyEl = document.getElementById("historyEmpty");
    const teamHistoryEl = document.getElementById("teamHistory");
    const teamEmptyEl = document.getElementById("teamEmpty");

    const LOCAL_HISTORY_KEY = "estate_ai_local_history_v1";
    const LOCAL_HISTORY_LIMIT = 25;

    let selectedFiles = [];     // supports multiple photos per scan
    let selectedUrls = [];      // object URLs for preview thumbnails
    let lastScanId = null;      // for refine

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function nowIso() { return new Date().toISOString(); }
    function formatTime(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso; } }
    function stripCodeFences(s) { return String(s ?? "").replace(/```json|```/gi, "").trim(); }

    async function readJsonOrText(resp) {
      const ct = resp.headers.get("content-type") || "";
      if (ct.includes("application/json")) return await resp.json();
      const text = await resp.text();
      try { return JSON.parse(stripCodeFences(text)); } catch { return { detail: text }; }
    }

    function extractResult(payload) {
      if (payload && typeof payload === "object" && payload.result && typeof payload.result === "object") return payload.result;
      return payload;
    }

    function fmtUsd(n) {
      const num = Number(n);
      if (!isFinite(num)) return "";
      try {
        return new Intl.NumberFormat(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 0 }).format(num);
      } catch {
        return `$${Math.round(num)}`;
      }
    }

    function getSelectedMode() {
      const el = document.querySelector('input[name="mode"]:checked');
      return el ? el.value : "single";
    }

    // -------------------------
    // Local history (text only)
    // -------------------------
    function readLocalHistory() {
      try {
        const raw = localStorage.getItem(LOCAL_HISTORY_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }
    function writeLocalHistory(items) {
      localStorage.setItem(LOCAL_HISTORY_KEY, JSON.stringify(items));
    }
    function addToLocalHistory(entry) {
      const items = readLocalHistory();
      items.unshift(entry);
      writeLocalHistory(items.slice(0, LOCAL_HISTORY_LIMIT));
      renderLocalHistory();
    }
    function clearLocalHistory() {
      localStorage.removeItem(LOCAL_HISTORY_KEY);
      renderLocalHistory();
      statusEl.textContent = "";
      resultEl.innerHTML = "";
      preview.style.display = "none";
      previewHint.textContent = "Local history cleared.";
      clearSelected();
    }

    // -------------------------
    // Selection / preview
    // -------------------------
    function clearSelected() {
      selectedFiles = [];
      selectedUrls.forEach(u => URL.revokeObjectURL(u));
      selectedUrls = [];
      previewStrip.innerHTML = "";
    }

    function renderPreviewStrip() {
      previewStrip.innerHTML = "";
      selectedUrls.forEach((u, i) => {
        const img = document.createElement("img");
        img.className = "previewThumb";
        img.src = u;
        img.title = `Photo ${i+1}`;
        previewStrip.appendChild(img);
      });
    }

    function setMainPreviewFromFirst() {
      if (!selectedUrls.length) {
        preview.style.display = "none";
        return;
      }
      preview.src = selectedUrls[0];
      preview.style.display = "block";
    }

    function handleAddFiles(files) {
      if (!files || !files.length) return;

      for (const f of files) {
        if (selectedFiles.length >= 4) break; // matches backend default MAX_PHOTOS_PER_SCAN
        selectedFiles.push(f);
        const u = URL.createObjectURL(f);
        selectedUrls.push(u);
      }

      setMainPreviewFromFirst();
      renderPreviewStrip();

      previewHint.textContent = selectedFiles.length > 1
        ? `Ready to analyze (${selectedFiles.length} photos).`
        : "Ready to analyze.";

      statusEl.textContent = "";
      resultEl.innerHTML = "";
    }

    function openCamera() { cameraInput.value = ""; cameraInput.click(); }
    function openGallery() { galleryInput.value = ""; galleryInput.click(); }
    function addDetailPhoto() { extraInput.value = ""; extraInput.click(); }

    cameraInput.addEventListener("change", () => handleAddFiles(cameraInput.files));
    galleryInput.addEventListener("change", () => { clearSelected(); handleAddFiles(galleryInput.files); });
    extraInput.addEventListener("change", () => handleAddFiles(extraInput.files));

    // -------------------------
    // Confidence + tips + questions
    // -------------------------
    function confidenceBadge(conf) {
      if (typeof conf !== "number" || !isFinite(conf)) return "";
      const pct = Math.max(0, Math.min(100, Math.round(conf * 100)));
      let label = "Medium", cls = "confMed";
      if (pct >= 75) { label = "High"; cls = "confHigh"; }
      else if (pct < 45) { label = "Low"; cls = "confLow"; }
      return `
        <div class="confWrap">
          <div class="confPill ${cls}">
            <strong>Confidence</strong>
            <span>${escapeHtml(String(pct))}%</span>
            <span>(${escapeHtml(label)})</span>
          </div>
        </div>
      `;
    }

    function tipBoxFromClarity(clarityNotes, nextTip) {
      const cn = (clarityNotes || "").trim();
      const nt = (nextTip || "").trim();
      if (!cn && !nt) return "";
      return `
        <div class="tipBox">
          ${cn ? `<div><strong>Clarity notes:</strong> ${escapeHtml(cn)}</div>` : ""}
          ${nt ? `<div style="margin-top:6px;"><strong>Try this:</strong> ${escapeHtml(nt)}</div>` : ""}
          <ul>
            <li>Get closer to labels / maker marks</li>
            <li>Reduce glare and improve lighting</li>
            <li>Take a second angle if needed</li>
          </ul>
        </div>
      `;
    }

    function renderWhatToCheck(what) {
      if (!Array.isArray(what) || !what.length) return "";
      const lis = what.map(x => `
        <li>
          <strong>${escapeHtml(x.label || "")}</strong><br/>
          <span>${escapeHtml(x.why_it_matters || "")}</span><br/>
          <em>${escapeHtml(x.how_to_check || "")}</em>
        </li>
      `).join("");
      return `
        <div class="tipBox">
          <div style="font-weight:900; margin-bottom:6px;">What to check next</div>
          <ul>${lis}</ul>
        </div>
      `;
    }

    let pendingAnswers = {}; // {question_id: "Yes|No|Not sure"}

    function renderQuestions(questions) {
      pendingAnswers = {};
      if (!Array.isArray(questions) || !questions.length) return "";

      const blocks = questions.map(q => {
        const qid = q.id || "";
        const answers = Array.isArray(q.answers) ? q.answers : ["Yes","No","Not sure"];
        return `
          <div class="qaItem" data-qid="${escapeHtml(qid)}">
            <div class="qaQ">${escapeHtml(q.question || "")}</div>
            <div class="qaBtns">
              ${answers.map(a => `<button type="button" data-answer="${escapeHtml(a)}">${escapeHtml(a)}</button>`).join("")}
            </div>
            ${q.why ? `<div class="qaWhy">${escapeHtml(q.why)}</div>` : ""}
          </div>
        `;
      }).join("");

      return `
        <div class="qaBox">
          <div style="font-weight:900;">Quick questions (improves pricing)</div>
          ${blocks}
          <div style="margin-top:10px;">
            <button class="primary" type="button" onclick="refineWithAnswers()">Refine with answers</button>
            <span class="modeNote">Tip: Add a detail photo (mark/stamp) before refining if you can.</span>
          </div>
        </div>
      `;
    }

    function wireQuestionButtons(container) {
      const items = Array.from(container.querySelectorAll(".qaItem"));
      items.forEach(item => {
        const qid = item.getAttribute("data-qid") || "";
        const btns = Array.from(item.querySelectorAll("button[data-answer]"));
        btns.forEach(btn => {
          btn.addEventListener("click", () => {
            btns.forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            pendingAnswers[qid] = btn.getAttribute("data-answer") || "";
          });
        });
      });
    }

    // -------------------------
    // Render result (single + multi)
    // -------------------------
    function renderSingle(data) {
      const title = (data.title ?? "").trim();
      const category = (data.category ?? "").trim();
      const condition = (data.condition_notes ?? "").trim();
      const low = (data.price_range_low != null) ? Number(data.price_range_low) : null;
      const high = (data.price_range_high != null) ? Number(data.price_range_high) : null;
      const listPrice = (data.suggested_list_price != null) ? Number(data.suggested_list_price) : null;
      const keywords = Array.isArray(data.keywords) ? data.keywords.filter(Boolean) : [];
      const rationale = String(data.rationale ?? "").trim();

      const rangeStr = (isFinite(low) && isFinite(high)) ? `${fmtUsd(low)} – ${fmtUsd(high)}` : "";
      const listStr = isFinite(listPrice) ? fmtUsd(listPrice) : "";

      resultEl.innerHTML = `
        <div class="resultLine"><span class="label">Item:</span> ${escapeHtml(title || "Unknown item")}</div>
        ${category ? `<div class="resultLine"><span class="label">Category:</span> ${escapeHtml(category)}</div>` : ""}
        ${condition ? `<div class="resultLine"><span class="label">Condition Notes:</span> ${escapeHtml(condition)}</div>` : ""}
        ${rangeStr ? `<div class="resultLine"><span class="label">Estimated Value Range:</span> ${escapeHtml(rangeStr)}</div>` : ""}
        ${listStr ? `<div class="resultLine"><span class="label">Suggested Listing Price:</span> ${escapeHtml(listStr)}</div>` : ""}
        ${confidenceBadge(data.confidence)}
        ${keywords.length ? `<div class="resultLine"><span class="label">Keywords:</span> ${escapeHtml(keywords.join(", "))}</div>` : ""}
        ${rationale ? `<div class="resultLine" style="margin-top:10px;"><span class="label">Rationale:</span><pre>${escapeHtml(rationale)}</pre></div>` : ""}
        ${renderWhatToCheck(data.what_to_check)}
        ${renderQuestions(data.followup_questions)}
        ${tipBoxFromClarity(data.clarity_notes, data.next_photo_tip)}
      `;

      wireQuestionButtons(resultEl);
    }

    function renderMulti(data) {
      const bundle = data.bundle || {};
      const items = Array.isArray(data.items) ? data.items : [];
      const recommendation = String(data.recommendation ?? "").trim();
      const extras = Array.isArray(data.additional_items_seen) ? data.additional_items_seen : [];

      const bTitle = String(bundle.title ?? "Bundle").trim();
      const bLow = (bundle.price_range_low != null) ? Number(bundle.price_range_low) : null;
      const bHigh = (bundle.price_range_high != null) ? Number(bundle.price_range_high) : null;
      const bList = (bundle.suggested_list_price != null) ? Number(bundle.suggested_list_price) : null;
      const bRange = (isFinite(bLow) && isFinite(bHigh)) ? `${fmtUsd(bLow)} – ${fmtUsd(bHigh)}` : "";
      const bListStr = isFinite(bList) ? fmtUsd(bList) : "";
      const bRat = String(bundle.rationale ?? "").trim();

      const itemCards = items.map((it, idx) => {
        const t = String(it.title ?? `Item ${idx+1}`).trim();
        const low = (it.price_range_low != null) ? Number(it.price_range_low) : null;
        const high = (it.price_range_high != null) ? Number(it.price_range_high) : null;
        const lp = (it.suggested_list_price != null) ? Number(it.suggested_list_price) : null;
        const range = (isFinite(low) && isFinite(high)) ? `${fmtUsd(low)}–${fmtUsd(high)}` : "";
        const price = isFinite(lp) ? fmtUsd(lp) : "";
        return `
          <div class="miniCard" data-idx="${idx}">
            <div class="miniTitle">${escapeHtml(t)}</div>
            <div>${escapeHtml(range)} ${price ? " • " + escapeHtml(price) : ""}</div>
          </div>
        `;
      }).join("");

      resultEl.innerHTML = `
        <div class="sectionTitle">Bundle / Lot</div>
        <div class="resultLine"><span class="label">Title:</span> ${escapeHtml(bTitle)}</div>
        ${bRange ? `<div class="resultLine"><span class="label">Bundle Value Range:</span> ${escapeHtml(bRange)}</div>` : ""}
        ${bListStr ? `<div class="resultLine"><span class="label">Bundle List Price:</span> ${escapeHtml(bListStr)}</div>` : ""}
        ${confidenceBadge(bundle.confidence)}
        ${recommendation ? `<div class="resultLine"><span class="label">Recommendation:</span> ${escapeHtml(recommendation)}</div>` : ""}
        ${bRat ? `<div class="resultLine" style="margin-top:10px;"><span class="label">Bundle Rationale:</span><pre>${escapeHtml(bRat)}</pre></div>` : ""}

        <div class="sectionTitle">Items (up to 8)</div>
        ${items.length ? itemCards : `<div class="status">No individual items were returned.</div>`}

        ${extras.length ? `
          <div class="tipBox">
            <div><strong>More items may be visible:</strong></div>
            <div style="margin-top:6px;">${escapeHtml(extras.join(", "))}</div>
            <div style="margin-top:8px;"><strong>Tip:</strong> Take a closer photo of missing items for individual pricing.</div>
          </div>
        ` : ""}

        <div id="multiDetail"></div>

        ${renderWhatToCheck(data.what_to_check)}
        ${renderQuestions(data.followup_questions)}
        ${tipBoxFromClarity(data.clarity_notes, data.next_photo_tip)}
      `;

      wireQuestionButtons(resultEl);

      const detailEl = document.getElementById("multiDetail");
      const cards = Array.from(resultEl.querySelectorAll(".miniCard"));

      function showDetail(idx) {
        cards.forEach(c => c.classList.remove("selected"));
        const card = cards[idx];
        if (card) card.classList.add("selected");

        const it = items[idx] || {};
        const t = String(it.title ?? "Item").trim();
        const cat = String(it.category ?? "").trim();
        const cond = String(it.condition_notes ?? "").trim();
        const low = (it.price_range_low != null) ? Number(it.price_range_low) : null;
        const high = (it.price_range_high != null) ? Number(it.price_range_high) : null;
        const lp = (it.suggested_list_price != null) ? Number(it.suggested_list_price) : null;
        const range = (isFinite(low) && isFinite(high)) ? `${fmtUsd(low)} – ${fmtUsd(high)}` : "";
        const price = isFinite(lp) ? fmtUsd(lp) : "";
        const kw = Array.isArray(it.keywords) ? it.keywords.filter(Boolean) : [];
        const rat = String(it.rationale ?? "").trim();

        detailEl.innerHTML = `
          <div class="sectionTitle">Selected Item</div>
          <div class="resultLine"><span class="label">Item:</span> ${escapeHtml(t)}</div>
          ${cat ? `<div class="resultLine"><span class="label">Category:</span> ${escapeHtml(cat)}</div>` : ""}
          ${cond ? `<div class="resultLine"><span class="label">Condition Notes:</span> ${escapeHtml(cond)}</div>` : ""}
          ${range ? `<div class="resultLine"><span class="label">Value Range:</span> ${escapeHtml(range)}</div>` : ""}
          ${price ? `<div class="resultLine"><span class="label">List Price:</span> ${escapeHtml(price)}</div>` : ""}
          ${confidenceBadge(it.confidence)}
          ${kw.length ? `<div class="resultLine"><span class="label">Keywords:</span> ${escapeHtml(kw.join(", "))}</div>` : ""}
          ${rat ? `<div class="resultLine" style="margin-top:10px;"><span class="label">Rationale:</span><pre>${escapeHtml(rat)}</pre></div>` : ""}
        `;
      }

      cards.forEach(c => {
        c.addEventListener("click", () => showDetail(Number(c.dataset.idx)));
        c.addEventListener("touchend", (e) => { e.preventDefault(); showDetail(Number(c.dataset.idx)); }, { passive: false });
      });

      if (items.length) showDetail(0);
    }

    function renderResult(payloadOrResult) {
      const data = extractResult(payloadOrResult);

      if (!data || typeof data !== "object") {
        resultEl.innerHTML = `<pre>${escapeHtml(String(data))}</pre>`;
        return;
      }
      if (data.error) {
        statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(data.error)}`;
        if (data.raw) resultEl.innerHTML = `<pre>${escapeHtml(data.raw)}</pre>`;
        return;
      }

      if (data.mode === "multi") renderMulti(data);
      else renderSingle(data);
    }

    // -------------------------
    // Refine flow
    // -------------------------
    async function refineWithAnswers() {
      if (!lastScanId) {
        statusEl.innerHTML = `<span class="err">No scan to refine.</span>`;
        return;
      }

      // only send answered questions
      const answers = {};
      Object.keys(pendingAnswers || {}).forEach(k => {
        if (pendingAnswers[k]) answers[k] = pendingAnswers[k];
      });

      analyzeBtn.disabled = true;
      statusEl.textContent = "Refining…";

      const formData = new FormData();
      formData.append("scan_id", String(lastScanId));
      formData.append("answers_json", JSON.stringify(answers));

      // Optional: if user added extra detail photos after the scan,
      // we can send current selectedFiles as extra_images, BUT that would resend originals too.
      // Keep it simple: do not auto-send; users can re-run Analyze with more photos.
      // (You can enhance later.)

      try {
        const resp = await fetch("/refine", { method: "POST", body: formData });
        if (resp.status === 401) { window.location.href = "/login"; return; }
        const payload = await readJsonOrText(resp);
        if (!resp.ok) throw new Error(payload?.detail || "Refine failed");

        statusEl.innerHTML = `<span class="ok">Updated ✅</span>`;
        lastScanId = payload.scan_id || lastScanId;
        renderResult(payload);

        await refreshTeamHistory();
        resultEl.scrollIntoView({ behavior: "smooth", block: "start" });

      } catch (e) {
        statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(e.message)}`;
      } finally {
        analyzeBtn.disabled = false;
      }
    }

    // -------------------------
    // History rendering
    // -------------------------
    function renderLocalHistory() {
      const items = readLocalHistory();
      historyEl.innerHTML = "";

      if (!items.length) { historyEmptyEl.style.display = "block"; return; }
      historyEmptyEl.style.display = "none";

      items.forEach((item, idx) => {
        const r = item?.result || {};
        const title =
          (r.mode === "multi" ? (r.bundle?.title || "Multi-item lot") : (r.title || "Unknown item"));
        const time = item?.created_at ? formatTime(item.created_at) : "";

        const price =
          (r.mode === "multi"
            ? (r.bundle?.suggested_list_price != null ? fmtUsd(r.bundle.suggested_list_price) : "")
            : (r?.suggested_list_price != null ? fmtUsd(r.suggested_list_price) : "")
          );

        const range =
          (r.mode === "multi"
            ? (r.bundle?.price_range_low != null && r.bundle?.price_range_high != null
                ? `${fmtUsd(r.bundle.price_range_low)}–${fmtUsd(r.bundle.price_range_high)}`
                : "")
            : (r?.price_range_low != null && r?.price_range_high != null
                ? `${fmtUsd(r.price_range_low)}–${fmtUsd(r.price_range_high)}`
                : "")
          );

        const div = document.createElement("div");
        div.className = "historyItem";
        div.onclick = () => openLocalHistoryItem(idx);

        div.innerHTML = `
          <div class="thumbPlaceholder">No image</div>
          <div class="historyMeta">
            <div class="title">${escapeHtml(String(title))}</div>
            <div>${escapeHtml(range)} ${price ? " • " + escapeHtml(price) : ""}</div>
            <div class="time">${escapeHtml(time)}</div>
          </div>
        `;
        historyEl.appendChild(div);
      });
    }

    function openLocalHistoryItem(index) {
      const items = readLocalHistory();
      const item = items[index];
      if (!item) return;

      lastScanId = null;
      statusEl.innerHTML = `<span class="ok">Loaded ✅</span>`;
      renderResult(item.result);
      resultEl.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function renderTeamHistory(items) {
      teamHistoryEl.innerHTML = "";
      if (!items || !items.length) { teamEmptyEl.style.display = "block"; return; }
      teamEmptyEl.style.display = "none";

      items.forEach((item) => {
        const r = item?.result || {};
        const title =
          (r.mode === "multi" ? (r.bundle?.title || item.title || "Multi-item lot") : (r.title || item.title || "Unknown item"));
        const time = item?.created_at ? formatTime(item.created_at) : "";

        const price =
          (r.mode === "multi"
            ? (r.bundle?.suggested_list_price != null ? fmtUsd(r.bundle.suggested_list_price) : "")
            : (r?.suggested_list_price != null ? fmtUsd(r.suggested_list_price) : "")
          );

        const range =
          (r.mode === "multi"
            ? (r.bundle?.price_range_low != null && r.bundle?.price_range_high != null
                ? `${fmtUsd(r.bundle.price_range_low)}–${fmtUsd(r.bundle.price_range_high)}`
                : "")
            : (r?.price_range_low != null && r?.price_range_high != null
                ? `${fmtUsd(r.price_range_low)}–${fmtUsd(r.price_range_high)}`
                : "")
          );

        const imgSrc = item.image_url || "";

        const div = document.createElement("div");
        div.className = "historyItem";

        div.innerHTML = `
          ${imgSrc ? `<img class="thumb" src="${escapeHtml(imgSrc)}" alt="thumb" />` : `<div class="thumbPlaceholder">No image</div>`}
          <div class="historyMeta">
            <div class="title">${escapeHtml(String(title))}</div>
            <div>${escapeHtml(range)} ${price ? " • " + escapeHtml(price) : ""}</div>
            <div class="time">${escapeHtml(time)}</div>
            <div class="badge">Shared with your team</div>
          </div>
        `;

        const onSelect = () => {
          teamHistoryEl.querySelectorAll(".historyItem.selected").forEach(el => el.classList.remove("selected"));
          div.classList.add("selected");

          lastScanId = item.scan_id || null;

          if (imgSrc) {
            preview.src = imgSrc;
            preview.style.display = "block";
            previewHint.textContent = "Loaded from team history.";
          }

          statusEl.innerHTML = `<span class="ok">Loaded ✅</span>`;
          renderResult(item.result);
          resultEl.scrollIntoView({ behavior: "smooth", block: "start" });
        };

        div.addEventListener("click", onSelect);
        div.addEventListener("touchend", (e) => { e.preventDefault(); onSelect(); }, { passive: false });

        teamHistoryEl.appendChild(div);
      });
    }

    async function refreshTeamHistory() {
      try {
        const resp = await fetch("/history?limit=25");
        if (resp.status === 401) { window.location.href = "/login"; return; }
        if (!resp.ok) return;
        const data = await resp.json();
        renderTeamHistory(data.items || []);
      } catch (e) {
        console.error(e);
      }
    }

    // -------------------------
    // Analyze
    // -------------------------
    async function analyze() {
      if (!selectedFiles.length) {
        statusEl.innerHTML = `<span class="err">Select a photo first.</span>`;
        return;
      }

      analyzeBtn.disabled = true;
      statusEl.textContent = "Analyzing…";
      resultEl.innerHTML = "";

      const formData = new FormData();
      // Backend expects repeated "images"
      selectedFiles.forEach(f => formData.append("images", f));
      formData.append("analysis_mode", getSelectedMode());

      try {
        const resp = await fetch("/analyze-image", { method: "POST", body: formData });
        if (resp.status === 401) { window.location.href = "/login"; return; }

        const payload = await readJsonOrText(resp);
        if (!resp.ok) throw new Error(payload?.detail || "Analyze failed");

        statusEl.innerHTML = `<span class="ok">Done ✅</span>`;
        lastScanId = payload.scan_id || null;

        renderResult(payload);

        const r = extractResult(payload);
        if (r && typeof r === "object" && !r.error) {
          addToLocalHistory({ created_at: payload.created_at || nowIso(), result: r });
        }

        await refreshTeamHistory();
        resultEl.scrollIntoView({ behavior: "smooth", block: "start" });

      } catch (e) {
        statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(e.message)}`;
      } finally {
        analyzeBtn.disabled = false;
      }
    }

    // Init
    renderLocalHistory();
    refreshTeamHistory();
  </script>
</body>
</html>
