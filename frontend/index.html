<!-- frontend/index.html
     ✅ Estate AI Scanner — Camera + Local History + Shared Team History
     - NO login logic in frontend (backend handles /login redirect)
     - "Use Camera" opens rear camera on phones
     - Local History saved per device (localStorage) — TEXT ONLY (no base64 images; avoids quota)
     - Team History pulled from server (shared) — includes thumbnails from backend
-->

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estate AI Scanner</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 6px; }
    .sub { margin: 0 0 16px; color: #555; }

    .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin: 10px 0 18px; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button.primary { background: #2b7cff; color: #fff; border-color: #2b7cff; font-weight: 700; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .grid { display: grid; grid-template-columns: 360px 1fr; gap: 18px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; background: #fff; }
    .card h3 { margin: 0 0 10px; }

    #preview {
      width: 100%;
      max-height: 520px;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid #eee;
      display: none;
    }

    .status { margin: 8px 0 0; color: #666; font-size: 13px; }
    .ok { color: #0a7a0a; font-weight: 700; }
    .err { color: #b00020; font-weight: 700; }

    .resultLine { margin: 6px 0; line-height: 1.25; }
    .label { font-weight: 800; }

    .historyList { display: flex; flex-direction: column; gap: 10px; }
    .historyItem {
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 10px;
      align-items: center;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 8px;
      cursor: pointer;
    }
    .historyItem:hover { background: #fafafa; }
    .thumb {
      width: 72px; height: 72px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #eee;
      display: block;
      background: #f7f7f7;
    }
    .thumbPlaceholder {
      width: 72px; height: 72px;
      border-radius: 8px;
      border: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f7f7f7;
      color: #777;
      font-size: 12px;
      user-select: none;
    }
    .historyMeta { font-size: 13px; color: #444; }
    .historyMeta .title { font-weight: 800; color: #111; margin-bottom: 2px; }
    .historyMeta .time { color: #666; font-size: 12px; }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #f7f7f7;
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0 0;
    }

    .small { font-size: 12px; color: #666; margin-top: 10px; }
  </style>
</head>

<body>
  <h1>Estate AI Scanner</h1>
  <p class="sub" id="subtitle">Snap a photo, identify the item, and get an estimate.</p>

  <!-- Hidden inputs: Camera + Gallery -->
  <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none" />
  <input id="galleryInput" type="file" accept="image/*" style="display:none" />

  <div class="controls">
    <button onclick="openCamera()">Use Camera</button>
    <button onclick="openGallery()">Choose From Photos</button>
    <button id="analyzeBtn" class="primary" onclick="analyze()">Analyze</button>

    <button onclick="refreshTeamHistory()">Refresh Team History</button>
    <button onclick="clearLocalHistory()">Clear Local History</button>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Preview</h3>
      <img id="preview" alt="Preview" />
      <div id="previewHint" class="status">Select a photo to begin.</div>

      <div class="small">
        Tip: On phones, “Use Camera” should open the rear camera automatically.
      </div>
    </div>

    <div class="card">
      <h3>Result</h3>
      <div id="status" class="status"></div>
      <div id="result"></div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <h3>Team History (shared)</h3>
      <div id="teamHistory" class="historyList"></div>
      <div id="teamEmpty" class="status">No team scans yet.</div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <h3>Local History (this device)</h3>
      <div id="history" class="historyList"></div>
      <div id="historyEmpty" class="status">No local scans saved yet.</div>
      <div class="small">Note: Local history stores results only (no photos) to avoid storage limits on phones.</div>
    </div>
  </div>

  <script>
    // =========================
    // Elements
    // =========================
    const cameraInput = document.getElementById("cameraInput");
    const galleryInput = document.getElementById("galleryInput");
    const preview = document.getElementById("preview");
    const previewHint = document.getElementById("previewHint");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const analyzeBtn = document.getElementById("analyzeBtn");

    const historyEl = document.getElementById("history");
    const historyEmptyEl = document.getElementById("historyEmpty");

    const teamHistoryEl = document.getElementById("teamHistory");
    const teamEmptyEl = document.getElementById("teamEmpty");

    // =========================
    // Local state
    // =========================
    let selectedFile = null;
    let selectedDataUrl = null; // used only for current preview during selection
    let lastObjectUrl = null;

    const LOCAL_HISTORY_KEY = "estate_ai_local_history_v1";
    const LOCAL_HISTORY_LIMIT = 25;

    // =========================
    // Helpers
    // =========================
    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function nowIso() {
      return new Date().toISOString();
    }

    function formatTime(iso) {
      try { return new Date(iso).toLocaleString(); }
      catch { return iso; }
    }

    function stripCodeFences(s) {
      return String(s ?? "").replace(/```json|```/gi, "").trim();
    }

    async function readJsonOrText(resp) {
      const ct = resp.headers.get("content-type") || "";
      if (ct.includes("application/json")) return await resp.json();
      const text = await resp.text();
      try { return JSON.parse(stripCodeFences(text)); } catch { return { detail: text }; }
    }

    function extractResult(payload) {
      // Backend returns: { scan_id, created_at, company_code, result: {...} }
      if (payload && typeof payload === "object" && payload.result && typeof payload.result === "object") {
        return payload.result;
      }
      // Fallback if backend returns result object directly
      return payload;
    }

    // =========================
    // Local history (device) — TEXT ONLY
    // =========================
    function readLocalHistory() {
      try {
        const raw = localStorage.getItem(LOCAL_HISTORY_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function writeLocalHistory(items) {
      localStorage.setItem(LOCAL_HISTORY_KEY, JSON.stringify(items));
    }

    function addToLocalHistory(entry) {
      const items = readLocalHistory();
      items.unshift(entry);
      writeLocalHistory(items.slice(0, LOCAL_HISTORY_LIMIT));
      renderLocalHistory();
    }

    function clearLocalHistory() {
      localStorage.removeItem(LOCAL_HISTORY_KEY);
      renderLocalHistory();
      statusEl.textContent = "";
      resultEl.innerHTML = "";
      preview.style.display = "none";
      previewHint.textContent = "Local history cleared.";
    }

    function renderResult(resultObj) {
      const data = extractResult(resultObj);

      if (!data || typeof data !== "object") {
        resultEl.innerHTML = `<pre>${escapeHtml(String(data))}</pre>`;
        return;
      }

      if (data.error) {
        statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(data.error)}`;
        if (data.raw) resultEl.innerHTML = `<pre>${escapeHtml(data.raw)}</pre>`;
        return;
      }

      // Supports your older schema (item_name...) AND the newer schema (title...)
      const itemName = data.item_name ?? data.title ?? "Unknown item";
      const brand = data.brand_or_origin ?? data.brand ?? data.category ?? "";
      const range = data.estimated_value_range ?? (
        (data.price_range_low != null && data.price_range_high != null)
          ? `$${data.price_range_low}–$${data.price_range_high}`
          : ""
      );
      const price = data.suggested_listing_price ?? (
        data.suggested_list_price != null ? `$${data.suggested_list_price}` : ""
      );
      const condition = data.condition_assumptions ?? data.condition_notes ?? "";

      const kw = Array.isArray(data.keywords_for_listing)
        ? data.keywords_for_listing.join(", ")
        : Array.isArray(data.keywords)
          ? data.keywords.join(", ")
          : (data.keywords_for_listing ?? data.keywords ?? "");

      const sources = Array.isArray(data.pricing_sources)
        ? data.pricing_sources
        : (typeof data.pricing_sources === "string" && data.pricing_sources.trim()
            ? data.pricing_sources.split(",").map(s => s.trim()).filter(Boolean)
            : []);

      const rationale = Array.isArray(data.rationale) ? data.rationale.join("\n") : (data.rationale ?? "");

      resultEl.innerHTML = `
        <div class="resultLine"><span class="label">Item:</span> ${escapeHtml(itemName)}</div>
        ${brand ? `<div class="resultLine"><span class="label">Brand/Category:</span> ${escapeHtml(brand)}</div>` : ""}
        ${range ? `<div class="resultLine"><span class="label">Estimated Value Range:</span> ${escapeHtml(range)}</div>` : ""}
        ${price ? `<div class="resultLine"><span class="label">Suggested Listing Price:</span> ${escapeHtml(price)}</div>` : ""}
        ${condition ? `<div class="resultLine"><span class="label">Condition:</span> ${escapeHtml(condition)}</div>` : ""}
        ${kw ? `<div class="resultLine"><span class="label">Keywords:</span> ${escapeHtml(kw)}</div>` : ""}
        ${rationale ? `<div class="resultLine" style="margin-top:10px;"><span class="label">Rationale:</span><pre>${escapeHtml(rationale)}</pre></div>` : ""}
        ${sources.length ? `
          <div class="resultLine" style="margin-top:10px;">
            <span class="label">Pricing Sources:</span>
            <ul>${sources.map(s => `<li>${escapeHtml(s)}</li>`).join("")}</ul>
          </div>
        ` : ""}
      `;
    }

    function renderLocalHistory() {
      const items = readLocalHistory();
      historyEl.innerHTML = "";

      if (!items.length) {
        historyEmptyEl.style.display = "block";
        return;
      }
      historyEmptyEl.style.display = "none";

      items.forEach((item, idx) => {
        const r = item?.result || {};
        const title = r?.item_name ?? r?.title ?? "Unknown item";
        const time = item?.created_at ? formatTime(item.created_at) : "";
        const price = r?.suggested_listing_price ?? (r?.suggested_list_price != null ? `$${r.suggested_list_price}` : "");
        const range = r?.estimated_value_range ?? (
          (r?.price_range_low != null && r?.price_range_high != null) ? `$${r.price_range_low}–$${r.price_range_high}` : ""
        );

        const div = document.createElement("div");
        div.className = "historyItem";
        div.onclick = () => openLocalHistoryItem(idx);

        div.innerHTML = `
          <div class="thumbPlaceholder">No image</div>
          <div class="historyMeta">
            <div class="title">${escapeHtml(title)}</div>
            <div>${escapeHtml(range)} ${price ? " • " + escapeHtml(price) : ""}</div>
            <div class="time">${escapeHtml(time)}</div>
          </div>
        `;

        historyEl.appendChild(div);
      });
    }

    function openLocalHistoryItem(index) {
      const items = readLocalHistory();
      const item = items[index];
      if (!item) return;

      selectedFile = null;
      selectedDataUrl = null;

      preview.style.display = "none";
      previewHint.textContent = "Loaded from local history (no image stored on device).";

      statusEl.innerHTML = `<span class="ok">Loaded ✅</span>`;
      renderResult(item.result);
    }

    // =========================
    // Team History (shared)
    // =========================
    function renderTeamHistory(items) {
      teamHistoryEl.innerHTML = "";
      if (!items || !items.length) {
        teamEmptyEl.style.display = "block";
        return;
      }
      teamEmptyEl.style.display = "none";

      items.forEach((item) => {
        const r = item?.result || {};
        const title = r?.item_name ?? r?.title ?? item?.title ?? "Unknown item";
        const time = item?.created_at ? formatTime(item.created_at) : "";
        const price = r?.suggested_listing_price ?? (r?.suggested_list_price != null ? `$${r.suggested_list_price}` : "");
        const range = r?.estimated_value_range ?? (
          (r?.price_range_low != null && r?.price_range_high != null) ? `$${r.price_range_low}–$${r.price_range_high}` : ""
        );

        const imgSrc = item.image_url || "";

        const div = document.createElement("div");
        div.className = "historyItem";
        div.onclick = () => {
          selectedFile = null;
          selectedDataUrl = imgSrc || null;

          if (imgSrc) {
            preview.src = imgSrc;
            preview.style.display = "block";
            previewHint.textContent = "Loaded from team history.";
          } else {
            preview.style.display = "none";
            previewHint.textContent = "Loaded from team history.";
          }

          statusEl.innerHTML = `<span class="ok">Loaded ✅</span>`;
          renderResult(item.result);
        };

        div.innerHTML = `
          <img class="thumb" src="${escapeHtml(imgSrc)}" alt="thumb" />
          <div class="historyMeta">
            <div class="title">${escapeHtml(title)}</div>
            <div>${escapeHtml(range)} ${price ? " • " + escapeHtml(price) : ""}</div>
            <div class="time">${escapeHtml(time)}</div>
          </div>
        `;
        teamHistoryEl.appendChild(div);
      });
    }

    async function refreshTeamHistory() {
      try {
        const resp = await fetch("/history?limit=25");
        if (resp.status === 401) {
          renderTeamHistory([]);
          return;
        }
        if (!resp.ok) return;
        const data = await resp.json();
        renderTeamHistory(data.items || []);
      } catch (e) {
        console.error(e);
      }
    }

    // =========================
    // File selection
    // =========================
    function openCamera() {
      cameraInput.value = "";
      cameraInput.click();
    }

    function openGallery() {
      galleryInput.value = "";
      galleryInput.click();
    }

    function handleFileSelect(file) {
      if (!file) return;

      selectedFile = file;
      selectedDataUrl = null;

      statusEl.textContent = "";
      resultEl.innerHTML = "";

      analyzeBtn.disabled = true;
      previewHint.textContent = "Loading image…";

      if (lastObjectUrl) URL.revokeObjectURL(lastObjectUrl);
      lastObjectUrl = URL.createObjectURL(file);

      preview.src = lastObjectUrl;
      preview.style.display = "block";

      const reader = new FileReader();
      reader.onload = () => {
        selectedDataUrl = reader.result;
        previewHint.textContent = "Ready to analyze.";
        analyzeBtn.disabled = false;
      };
      reader.onerror = () => {
        previewHint.textContent = "Could not read image.";
        analyzeBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }

    cameraInput.addEventListener("change", () => handleFileSelect(cameraInput.files?.[0]));
    galleryInput.addEventListener("change", () => handleFileSelect(galleryInput.files?.[0]));

    // =========================
    // Analyze
    // =========================
    async function analyze() {
      if (!selectedFile) {
        statusEl.innerHTML = `<span class="err">Select a photo first.</span>`;
        return;
      }
      if (!selectedDataUrl) {
        statusEl.innerHTML = `<span class="err">Please wait—image still loading.</span>`;
        return;
      }

      analyzeBtn.disabled = true;
      statusEl.textContent = "Analyzing…";
      resultEl.innerHTML = "";

      const formData = new FormData();
      // IMPORTANT: backend expects field name "image"
      formData.append("image", selectedFile);

      try {
        const resp = await fetch("/analyze-image", { method: "POST", body: formData });

        if (resp.status === 401) {
          statusEl.innerHTML = `<span class="err">Not logged in.</span> Please refresh the page.`;
          return;
        }

        const payload = await readJsonOrText(resp);

        if (!resp.ok) {
          const msg = payload?.error || payload?.detail || `Server error ${resp.status}`;
          throw new Error(msg);
        }

        statusEl.innerHTML = `<span class="ok">Done ✅</span>`;
        renderResult(payload);

        const r = extractResult(payload);
        if (!r?.error) {
          // Local history: store results only (NO image) to avoid mobile storage quota
          addToLocalHistory({
            created_at: payload.created_at || nowIso(),
            result: r
          });
        }

        await refreshTeamHistory();

      } catch (e) {
        console.error(e);
        statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(e.message)}`;
        resultEl.innerHTML = "";
      } finally {
        analyzeBtn.disabled = false;
      }
    }

    // =========================
    // Init
    // =========================
    renderLocalHistory();
    refreshTeamHistory();
  </script>
</body>
</html>
