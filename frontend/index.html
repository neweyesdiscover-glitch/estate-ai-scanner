<!-- frontend/index.html
     ✅ Estate AI Scanner — Company Login + Camera + Local History + Shared Team History
     - Login required (company + passcode)
     - "Use Camera" opens rear camera on phones
     - Local History saved per device (localStorage)
     - Team History shared across same company (server DB)
-->

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estate AI Scanner</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 6px; }
    .sub { margin: 0 0 16px; color: #555; }

    .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin: 10px 0 18px; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button.primary { background: #2b7cff; color: #fff; border-color: #2b7cff; font-weight: 700; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .grid { display: grid; grid-template-columns: 360px 1fr; gap: 18px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; background: #fff; }
    .card h3 { margin: 0 0 10px; }

    #preview {
      width: 100%;
      max-height: 520px;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid #eee;
      display: none;
    }

    .status { margin: 8px 0 0; color: #666; font-size: 13px; }
    .ok { color: #0a7a0a; font-weight: 700; }
    .err { color: #b00020; font-weight: 700; }

    .resultLine { margin: 6px 0; line-height: 1.25; }
    .label { font-weight: 800; }

    .historyList { display: flex; flex-direction: column; gap: 10px; }
    .historyItem {
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 10px;
      align-items: center;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 8px;
      cursor: pointer;
    }
    .historyItem:hover { background: #fafafa; }
    .thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }
    .historyMeta { font-size: 13px; color: #444; }
    .historyMeta .title { font-weight: 800; color: #111; margin-bottom: 2px; }
    .historyMeta .time { color: #666; font-size: 12px; }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #f7f7f7;
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0 0;
    }

    .small { font-size: 12px; color: #666; margin-top: 10px; }

    /* =========================
       Login modal
       ========================= */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 999;
    }
    .modal {
      width: 520px;
      max-width: 100%;
      background: white;
      border-radius: 14px;
      border: 1px solid #ddd;
      box-shadow: 0 12px 35px rgba(0,0,0,0.25);
      padding: 16px;
    }
    .modal h2 { margin: 0 0 4px; }
    .tabs { display: flex; gap: 10px; margin: 10px 0 14px; }
    .tab {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      cursor: pointer;
      background: #fafafa;
      font-weight: 700;
    }
    .tab.active { background: #2b7cff; color: #fff; border-color: #2b7cff; }
    .field { margin: 10px 0; }
    .field input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
    }
    .modalActions { margin-top: 12px; display: flex; gap: 10px; }
    .modalMsg { margin-top: 8px; font-size: 13px; color: #b00020; }
    .whoami { margin: 8px 0 0; font-size: 13px; color: #555; }
  </style>
</head>

<body>
  <h1>Estate AI Scanner</h1>
  <p class="sub" id="subtitle">Company login required. Snap a photo, identify the item, and get an estimate.</p>

  <!-- Hidden inputs: Camera + Gallery -->
  <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none" />
  <input id="galleryInput" type="file" accept="image/*" style="display:none" />

  <div class="controls">
    <button onclick="openCamera()">Use Camera</button>
    <button onclick="openGallery()">Choose From Photos</button>
    <button id="analyzeBtn" class="primary" onclick="analyze()">Analyze</button>

    <button onclick="refreshTeamHistory()">Refresh Team History</button>
    <button onclick="clearLocalHistory()">Clear Local History</button>
    <button onclick="logout()" style="margin-left:auto;">Logout</button>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Preview</h3>
      <img id="preview" alt="Preview" />
      <div id="previewHint" class="status">Select a photo to begin.</div>

      <div class="small">
        Tip: On phones, “Use Camera” should open the rear camera automatically.
      </div>
    </div>

    <div class="card">
      <h3>Result</h3>
      <div id="status" class="status"></div>
      <div id="result"></div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <h3>Team History (shared)</h3>
      <div id="teamHistory" class="historyList"></div>
      <div id="teamEmpty" class="status">No team scans yet.</div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <h3>Local History (this device)</h3>
      <div id="history" class="historyList"></div>
      <div id="historyEmpty" class="status">No local scans saved yet.</div>
    </div>
  </div>



  <script>
    // =========================
    // Elements
    // =========================
    const cameraInput = document.getElementById("cameraInput");
    const galleryInput = document.getElementById("galleryInput");
    const preview = document.getElementById("preview");
    const previewHint = document.getElementById("previewHint");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const analyzeBtn = document.getElementById("analyzeBtn");

    const historyEl = document.getElementById("history");
    const historyEmptyEl = document.getElementById("historyEmpty");

    const teamHistoryEl = document.getElementById("teamHistory");
    const teamEmptyEl = document.getElementById("teamEmpty");

    const overlay = document.getElementById("overlay");
    const tabLogin = document.getElementById("tabLogin");
    const tabCreate = document.getElementById("tabCreate");
    const authBtn = document.getElementById("authBtn");
    const authMsg = document.getElementById("authMsg");
    const whoami = document.getElementById("whoami");

    const companyInput = document.getElementById("companyInput");
    const passcodeInput = document.getElementById("passcodeInput");

    // =========================
    // Local state
    // =========================
    let selectedFile = null;
    let selectedDataUrl = null; // for local history saves
    let authMode = "login";     // "login" or "create"
    let currentCompany = null;

    const LOCAL_HISTORY_KEY = "estate_ai_local_history_v1";
    const LOCAL_HISTORY_LIMIT = 25;

    // =========================
    // Helpers
    // =========================
    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function nowIso() {
      return new Date().toISOString();
    }

    function formatTime(iso) {
      try { return new Date(iso).toLocaleString(); }
      catch { return iso; }
    }

    async function readJsonOrText(resp) {
      const ct = resp.headers.get("content-type") || "";
      if (ct.includes("application/json")) return await resp.json();
      const text = await resp.text();
      try { return JSON.parse(text); } catch { return { detail: text }; }
    }

    // =========================
    // Local history (device)
    // =========================
    function readLocalHistory() {
      try {
        const raw = localStorage.getItem(LOCAL_HISTORY_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function writeLocalHistory(items) {
      localStorage.setItem(LOCAL_HISTORY_KEY, JSON.stringify(items));
    }

    function addToLocalHistory(entry) {
      const items = readLocalHistory();
      items.unshift(entry);
      writeLocalHistory(items.slice(0, LOCAL_HISTORY_LIMIT));
      renderLocalHistory();
    }

    function clearLocalHistory() {
      localStorage.removeItem(LOCAL_HISTORY_KEY);
      renderLocalHistory();
      statusEl.textContent = "";
      resultEl.innerHTML = "";
    }

    function renderResult(data) {
      if (!data || typeof data !== "object") {
        resultEl.innerHTML = `<pre>${escapeHtml(String(data))}</pre>`;
        return;
      }

      if (data.error) {
        statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(data.error)}`;
        if (data.raw) resultEl.innerHTML = `<pre>${escapeHtml(data.raw)}</pre>`;
        return;
      }

      const kw = Array.isArray(data.keywords_for_listing)
        ? data.keywords_for_listing.join(", ")
        : (data.keywords_for_listing ?? "");

      const sources = Array.isArray(data.pricing_sources)
        ? data.pricing_sources
        : (typeof data.pricing_sources === "string" && data.pricing_sources.trim()
            ? data.pricing_sources.split(",").map(s => s.trim()).filter(Boolean)
            : []);

      resultEl.innerHTML = `
        <div class="resultLine"><span class="label">Item:</span> ${escapeHtml(data.item_name)}</div>
        <div class="resultLine"><span class="label">Brand/Origin:</span> ${escapeHtml(data.brand_or_origin)}</div>
        <div class="resultLine"><span class="label">Estimated Value Range:</span> ${escapeHtml(data.estimated_value_range)}</div>
        <div class="resultLine"><span class="label">Suggested Listing Price:</span> ${escapeHtml(data.suggested_listing_price)}</div>
        <div class="resultLine"><span class="label">Condition:</span> ${escapeHtml(data.condition_assumptions)}</div>
        <div class="resultLine"><span class="label">Keywords:</span> ${escapeHtml(kw)}</div>
        ${sources.length ? `
          <div class="resultLine" style="margin-top:10px;">
            <span class="label">Pricing Sources:</span>
            <ul>${sources.map(s => `<li>${escapeHtml(s)}</li>`).join("")}</ul>
          </div>
        ` : ""}
      `;
    }

    function renderLocalHistory() {
      const items = readLocalHistory();
      historyEl.innerHTML = "";

      if (!items.length) {
        historyEmptyEl.style.display = "block";
        return;
      }
      historyEmptyEl.style.display = "none";

      items.forEach((item, idx) => {
        const title = item?.result?.item_name || "Unknown item";
        const time = item?.created_at ? formatTime(item.created_at) : "";
        const price = item?.result?.suggested_listing_price || "";
        const range = item?.result?.estimated_value_range || "";

        const div = document.createElement("div");
        div.className = "historyItem";
        div.onclick = () => openLocalHistoryItem(idx);

        div.innerHTML = `
          <img class="thumb" src="${escapeHtml(item.image_data_url || "")}" alt="thumb" />
          <div class="historyMeta">
            <div class="title">${escapeHtml(title)}</div>
            <div>${escapeHtml(range)} ${price ? " • " + escapeHtml(price) : ""}</div>
            <div class="time">${escapeHtml(time)}</div>
          </div>
        `;

        historyEl.appendChild(div);
      });
    }

    function openLocalHistoryItem(index) {
      const items = readLocalHistory();
      const item = items[index];
      if (!item) return;

      selectedFile = null; // already analyzed
      selectedDataUrl = item.image_data_url || null;

      if (selectedDataUrl) {
        preview.src = selectedDataUrl;
        preview.style.display = "block";
        previewHint.textContent = "Loaded from local history.";
      }

      statusEl.innerHTML = `<span class="ok">Loaded ✅</span>`;
      renderResult(item.result);
    }

    // =========================
    // Team History (shared)
    // =========================
    function renderTeamHistory(items) {
      teamHistoryEl.innerHTML = "";
      if (!items || !items.length) {
        teamEmptyEl.style.display = "block";
        return;
      }
      teamEmptyEl.style.display = "none";

      items.forEach((item) => {
        const title = item?.result?.item_name || "Unknown item";
        const time = item?.created_at ? formatTime(item.created_at) : "";
        const price = item?.result?.suggested_listing_price || "";
        const range = item?.result?.estimated_value_range || "";

        const div = document.createElement("div");
        div.className = "historyItem";
        div.onclick = () => {
          // open result (no re-scan)
          selectedFile = null;
          selectedDataUrl = item.image_data_url || null;
          if (selectedDataUrl) {
            preview.src = selectedDataUrl;
            preview.style.display = "block";
            previewHint.textContent = "Loaded from team history.";
          }
          statusEl.innerHTML = `<span class="ok">Loaded ✅</span>`;
          renderResult(item.result);
        };

        div.innerHTML = `
          <img class="thumb" src="${escapeHtml(item.image_data_url || "")}" alt="thumb" />
          <div class="historyMeta">
            <div class="title">${escapeHtml(title)}</div>
            <div>${escapeHtml(range)} ${price ? " • " + escapeHtml(price) : ""}</div>
            <div class="time">${escapeHtml(time)}</div>
          </div>
        `;
        teamHistoryEl.appendChild(div);
      });
    }

    async function refreshTeamHistory() {
      try {
        const resp = await fetch("/team/history?limit=25");
        if (!resp.ok) {
          const err = await readJsonOrText(resp);
          if (resp.status === 401) showLogin(true, "Login required");
          return;
        }
        const data = await resp.json();
        renderTeamHistory(data.items || []);
      } catch (e) {
        console.error(e);
      }
    }

    // =========================
    // Auth modal
    // =========================
    function setAuthMode(mode) {
      authMode = mode;
      authMsg.textContent = "";
      tabLogin.classList.toggle("active", mode === "login");
      tabCreate.classList.toggle("active", mode === "create");
      authBtn.textContent = mode === "login" ? "Login" : "Create Company";
    }

    function showLogin(show, message) {
      overlay.style.display = show ? "flex" : "none";
      authMsg.textContent = message || "";
    }

    async function submitAuth() {
      authMsg.textContent = "";
      const company = (companyInput.value || "").trim();
      const passcode = (passcodeInput.value || "").trim();

      if (!company || !passcode) {
        authMsg.textContent = "Enter company + passcode.";
        return;
      }

      const endpoint = authMode === "login" ? "/login" : "/company/create";

      try {
        const resp = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ company, passcode })
        });

        const data = await readJsonOrText(resp);

        if (!resp.ok) {
          // display FastAPI error cleanly
          authMsg.textContent = data?.detail || "Request failed.";
          return;
        }

        if (authMode === "create") {
          // after creation, switch to login for clarity
          setAuthMode("login");
          authMsg.textContent = "Company created. Now login.";
          return;
        }

        // Logged in
        currentCompany = data.company;
        whoami.textContent = `Logged in as: ${currentCompany}`;
        showLogin(false);

        await refreshTeamHistory();

      } catch (e) {
        console.error(e);
        authMsg.textContent = "Network error.";
      }
    }

    async function ensureLoggedIn() {
      try {
        const resp = await fetch("/me");
        const data = await resp.json();
        if (!data.logged_in) {
          showLogin(true, "");
        } else {
          currentCompany = data.company;
          whoami.textContent = `Logged in as: ${currentCompany}`;
          showLogin(false);
          await refreshTeamHistory();
        }
      } catch (e) {
        console.error(e);
        showLogin(true, "Could not reach server.");
      }
    }

    async function logout() {
      try {
        await fetch("/logout", { method: "POST" });
      } catch {}
      currentCompany = null;
      showLogin(true, "Logged out.");
    }

    // =========================
    // File selection
    // =========================
    function openCamera() {
      cameraInput.value = "";
      cameraInput.click();
    }

    function openGallery() {
      galleryInput.value = "";
      galleryInput.click();
    }

    function handleFileSelect(file) {
      if (!file) return;

      selectedFile = file;
      statusEl.textContent = "";
      resultEl.innerHTML = "";

      const objectUrl = URL.createObjectURL(file);
      preview.src = objectUrl;
      preview.style.display = "block";
      previewHint.textContent = "Ready to analyze.";

      const reader = new FileReader();
      reader.onload = () => { selectedDataUrl = reader.result; };
      reader.readAsDataURL(file);
    }

    cameraInput.addEventListener("change", () => handleFileSelect(cameraInput.files?.[0]));
    galleryInput.addEventListener("change", () => handleFileSelect(galleryInput.files?.[0]));

    // =========================
    // Analyze
    // =========================
    async function analyze() {
      if (!selectedFile) {
        statusEl.innerHTML = `<span class="err">Select a photo first.</span>`;
        return;
      }

      analyzeBtn.disabled = true;
      statusEl.textContent = "Analyzing… (first scan may take ~30 seconds if server is waking up)";
      resultEl.innerHTML = "";

      const formData = new FormData();
      formData.append("file", selectedFile);

      try {
        const resp = await fetch("/analyze-image", { method: "POST", body: formData });

        if (!resp.ok) {
          const err = await readJsonOrText(resp);
          if (resp.status === 401) {
            showLogin(true, "Login required");
            throw new Error("Login required");
          }
          throw new Error(err?.detail || `Server error ${resp.status}`);
        }

        const data = await resp.json();

        statusEl.innerHTML = `<span class="ok">Done ✅</span>`;
        renderResult(data);

        // Save to local history (device)
        addToLocalHistory({
          created_at: nowIso(),
          image_data_url: selectedDataUrl,
          result: data
        });

        // Refresh shared team history
        await refreshTeamHistory();

      } catch (e) {
        console.error(e);
        statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(e.message)}`;
        resultEl.innerHTML = "";
      } finally {
        analyzeBtn.disabled = false;
      }
    }

    // =========================
    // Init
    // =========================
    renderLocalHistory();
    ensureLoggedIn();
  </script>
</body>
</html>
