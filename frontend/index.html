<!-- frontend/index.html
     ✅ Estate AI Scanner — Camera + Detail Photos + Local History + Team History
     - Backend handles /login redirect (NO login logic here)
     - Step 1 forces pricing mode choice (One vs Many)
     - Step 2 add photos (1 main + up to 3 detail)
     - Step 3 Analyze: "Identify and Price my item(s)"
     - Fixes: Error [object Object], price objects, tap highlight
-->

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estate AI Scanner</title>
  <style>
    :root {
      --card-border: #e7e7e7;
      --soft: #f7f7f7;
      --text: #111;
      --muted: #666;
      --primary: #2b7cff;
      --danger: #b00020;
      --ok: #0a7a0a;
      --shadow: 0 10px 30px rgba(0,0,0,0.06);
    }

    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 18px; max-width: 1100px; margin: 0 auto; color: var(--text); background: #fff; }
    h1 { margin: 0 0 6px; font-size: 26px; }
    .sub { margin: 0 0 16px; color: var(--muted); }

    .grid { display: grid; grid-template-columns: 420px 1fr; gap: 16px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card { border: 1px solid var(--card-border); border-radius: 18px; padding: 14px; background: #fff; box-shadow: var(--shadow); }
    .card h3 { margin: 0 0 10px; font-size: 18px; }
    .cardTitleRow { display:flex; align-items:center; justify-content:space-between; gap: 10px; }

    .stepHeader { display:flex; gap:12px; align-items:flex-start; margin-bottom: 10px; }
    .stepNum {
      width: 32px; height: 32px;
      border-radius: 12px;
      background: #111;
      color: #fff;
      display:flex; align-items:center; justify-content:center;
      font-weight: 800;
      flex: 0 0 auto;
      margin-top: 2px;
    }
    .stepTitle { font-weight: 900; font-size: 18px; margin: 0; }
    .stepSub { margin: 2px 0 0; color: var(--muted); font-size: 13px; line-height: 1.25; }

    /* “checkbox-style” (radio behavior) */
    .modeRow { display:flex; align-items:center; gap: 12px; flex-wrap: wrap; }
    .modeLabel { display:flex; align-items:center; gap: 10px; padding: 10px 12px; border: 1px solid var(--card-border); border-radius: 14px; cursor: pointer; background:#fff; }
    .modeLabel.selected { border-color: rgba(43,124,255,0.45); box-shadow: 0 0 0 3px rgba(43,124,255,0.12); }
    .fakeBox {
      width: 18px; height: 18px; border-radius: 6px;
      border: 2px solid #cfcfcf;
      display:inline-flex; align-items:center; justify-content:center;
      font-weight: 900; font-size: 14px; line-height: 1;
      color: #fff;
      background: #fff;
    }
    .modeLabel.selected .fakeBox { border-color: var(--primary); background: var(--primary); }
    .modeText { font-weight: 800; }
    .modeHint { color: var(--muted); font-size: 12px; margin-left: 6px; }
    .infoBtn {
      width: 22px; height: 22px; border-radius: 999px;
      border: 1px solid #d6d6d6;
      background: #fff;
      cursor: pointer;
      display:inline-flex; align-items:center; justify-content:center;
      font-weight: 900;
      color: #444;
      flex: 0 0 auto;
    }

    /* Buttons */
    button { padding: 12px 14px; border-radius: 14px; border: 1px solid #d6d6d6; background: #fff; cursor: pointer; font-weight: 700; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .btnWide { width: 100%; padding: 16px 14px; font-size: 16px; border-radius: 16px; }
    .primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btnRow { display:flex; flex-direction:column; gap: 10px; }
    .btnRow button { display:flex; align-items:center; justify-content:space-between; }
    .btnMeta { color: var(--muted); font-weight: 700; font-size: 12px; }

    /* Preview */
    #preview {
      width: 100%;
      max-height: 520px;
      object-fit: contain;
      border-radius: 14px;
      border: 1px solid #eee;
      display: none;
      background: #fff;
    }

    .thumbStrip { display:flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .thumbChip {
      border: 1px solid #eaeaea; border-radius: 12px; padding: 6px;
      display:flex; flex-direction:column; gap: 6px; width: 92px;
      background: #fff;
    }
    .thumbChip img { width: 100%; height: 68px; object-fit: cover; border-radius: 10px; border:1px solid #efefef; }
    .thumbChip .chipLabel { font-size: 11px; color: var(--muted); font-weight: 800; display:flex; justify-content:space-between; }
    .removeX { border: none; background: transparent; color:#888; cursor:pointer; font-weight: 900; padding: 0; }

    /* Tips */
    .tips {
      background: #f3f3f3;
      border: 1px solid #ededed;
      border-radius: 16px;
      padding: 12px;
      color: #222;
      line-height: 1.25;
      margin-top: 10px;
    }
    .tips b { display:block; margin-bottom: 6px; }

    /* Result */
    .status { margin: 8px 0 0; color: var(--muted); font-size: 13px; }
    .ok { color: var(--ok); font-weight: 900; }
    .err { color: var(--danger); font-weight: 900; }
    .resultCard { border: 1px dashed #ddd; border-radius: 16px; padding: 12px; background: #fafafa; }
    .resultHead { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .pill { font-size: 12px; font-weight: 900; color: #2b7cff; background: rgba(43,124,255,0.12); border: 1px solid rgba(43,124,255,0.18); padding: 6px 10px; border-radius: 999px; }
    .itemTitle { font-size: 22px; font-weight: 950; margin: 0; line-height: 1.05; }
    .metrics { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .metricBox { border: 1px solid #ededed; background:#fff; border-radius: 14px; padding: 10px; }
    .metricLabel { color: var(--muted); font-size: 12px; font-weight: 900; }
    .metricValue { font-size: 22px; font-weight: 950; margin-top: 2px; }

    details { margin-top: 10px; }
    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: var(--soft);
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 12px;
      margin: 8px 0 0;
      font-size: 12px;
    }

    /* History */
    .historyList { display: flex; flex-direction: column; gap: 10px; }
    .historyItem {
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 10px;
      align-items: center;
      border: 1px solid #eee;
      border-radius: 14px;
      padding: 10px;
      cursor: pointer;
      background: #fff;
    }
    .historyItem:hover { background: #fafafa; }
    .historyItem.selected { border-color: rgba(43,124,255,0.55); box-shadow: 0 0 0 3px rgba(43,124,255,0.14); }
    .thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 12px; border: 1px solid #eee; background:#fff; }
    .historyMeta { font-size: 13px; color: #444; }
    .historyMeta .title { font-weight: 900; color: #111; margin-bottom: 2px; }
    .historyMeta .time { color: #666; font-size: 12px; }
    .sharedPill { display:inline-flex; align-items:center; gap: 6px; margin-top: 6px; }

    /* Simple modal */
    .modalBackdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.35);
      display:none; align-items:center; justify-content:center; padding: 18px;
      z-index: 1000;
    }
    .modal {
      width: min(520px, 100%);
      background: #fff;
      border-radius: 18px;
      border: 1px solid #eaeaea;
      box-shadow: 0 20px 60px rgba(0,0,0,0.18);
      padding: 14px;
    }
    .modalTitle { font-weight: 950; font-size: 18px; margin: 0 0 6px; }
    .modalBody { color: #222; font-size: 14px; line-height: 1.35; }
    .modalActions { display:flex; justify-content:flex-end; margin-top: 12px; }
  </style>
</head>

<body>
  <h1>Estate AI Scanner</h1>
  <p class="sub">Identify and price items for estate sales. Start by choosing what you’re pricing, then add photos.</p>

  <!-- Hidden inputs -->
  <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none" />
  <input id="galleryInput" type="file" accept="image/*" style="display:none" />
  <input id="detailInput" type="file" accept="image/*" style="display:none" />

  <div class="grid">
    <!-- Left column: steps + preview -->
    <div class="card">
      <!-- Step 1 -->
      <div class="stepHeader">
        <div class="stepNum">1</div>
        <div>
          <div class="stepTitle">Price</div>
          <div class="stepSub">Choose one option to continue.</div>
        </div>
      </div>

      <div class="modeRow" style="margin-bottom:12px;">
        <div class="modeLabel" id="modeOneWrap" onclick="setMode('single')">
          <span class="fakeBox" id="modeOneBox">✓</span>
          <span class="modeText">One Item</span>
          <button class="infoBtn" onclick="event.stopPropagation(); openInfo('single')" aria-label="Info">i</button>
        </div>

        <div class="modeLabel" id="modeManyWrap" onclick="setMode('multi')">
          <span class="fakeBox" id="modeManyBox">✓</span>
          <span class="modeText">Many Items</span>
          <button class="infoBtn" onclick="event.stopPropagation(); openInfo('multi')" aria-label="Info">i</button>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="stepHeader" style="margin-top: 6px;">
        <div class="stepNum">2</div>
        <div>
          <div class="stepTitle">Select an option to Add Photos</div>
          <div class="stepSub">Add a main photo first. Then (optional) add up to 3 detail photos for markings, labels, or close-ups.</div>
        </div>
      </div>

      <div class="btnRow">
        <button onclick="openCamera()">
          <span>Use Camera</span>
          <span class="btnMeta">Main photo</span>
        </button>
        <button onclick="openGallery()">
          <span>Choose From Photos</span>
          <span class="btnMeta">Main photo</span>
        </button>
        <button onclick="openDetail()">
          <span>Add Detail Photo</span>
          <span class="btnMeta">Up to 3 extras</span>
        </button>
      </div>

      <img id="preview" alt="Preview" />
      <div id="previewHint" class="status">Select a main photo to begin.</div>

      <div class="thumbStrip" id="detailStrip" style="display:none;"></div>

      <div class="tips">
        <b>Scan tips:</b>
        • Add close-up photos of stamps, markings, signatures, or crisp edges.<br/>
        • If results are unclear or items are missed, take a brighter and closer photo.<br/><br/>
        <b>Limits:</b> Max photos per scan: <b>4</b>. Max items in multi-item mode: <b>8</b>.
      </div>
    </div>

    <!-- Right column: Identify + results -->
    <div class="card">
      <!-- Step 3 -->
      <div class="stepHeader">
        <div class="stepNum">3</div>
        <div>
          <div class="stepTitle">Identify &amp; price</div>
          <div class="stepSub">Select <b>Identify and Price my item(s)</b> to see results.</div>
        </div>
      </div>

      <button id="analyzeBtn" class="primary btnWide" onclick="analyze()">Identify and Price my item(s)</button>

      <div id="status" class="status" style="margin-top:12px;"></div>
      <div id="result" style="margin-top:10px;"></div>

      <details id="rawWrap" style="display:none;">
        <summary><b>Show raw JSON</b></summary>
        <pre id="rawJson"></pre>
      </details>
    </div>

    <!-- Team history -->
    <div class="card" style="grid-column: 1 / -1;">
      <div class="cardTitleRow">
        <h3 style="margin:0;">Team History (shared)</h3>
        <button onclick="refreshTeamHistory()">Refresh Team History</button>
      </div>
      <div id="teamHistory" class="historyList" style="margin-top:10px;"></div>
      <div id="teamEmpty" class="status">No team scans yet.</div>
    </div>

    <!-- Local history -->
    <div class="card" style="grid-column: 1 / -1;">
      <div class="cardTitleRow">
        <h3 style="margin:0;">Local History (this device)</h3>
        <button onclick="clearLocalHistory()">Clear Local History</button>
      </div>
      <div id="history" class="historyList" style="margin-top:10px;"></div>
      <div id="historyEmpty" class="status">No local scans saved yet.</div>
    </div>
  </div>

  <!-- Info modal -->
  <div class="modalBackdrop" id="modalBackdrop" onclick="closeInfo()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalTitle" id="modalTitle">Info</div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalActions">
        <button onclick="closeInfo()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Elements
    // =========================
    const cameraInput = document.getElementById("cameraInput");
    const galleryInput = document.getElementById("galleryInput");
    const detailInput = document.getElementById("detailInput");

    const preview = document.getElementById("preview");
    const previewHint = document.getElementById("previewHint");

    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const rawWrap = document.getElementById("rawWrap");
    const rawJson = document.getElementById("rawJson");

    const analyzeBtn = document.getElementById("analyzeBtn");

    const historyEl = document.getElementById("history");
    const historyEmptyEl = document.getElementById("historyEmpty");

    const teamHistoryEl = document.getElementById("teamHistory");
    const teamEmptyEl = document.getElementById("teamEmpty");

    const modeOneWrap = document.getElementById("modeOneWrap");
    const modeManyWrap = document.getElementById("modeManyWrap");

    const detailStrip = document.getElementById("detailStrip");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");

    // =========================
    // Local state
    // =========================
    let analysisMode = null; // 'single' | 'multi' (forced)
    let mainFile = null;
    let mainDataUrl = null;
    let mainObjectUrl = null;

    let detailFiles = [];     // up to 3
    let detailDataUrls = [];  // base64 versions for local history

    let selectedHistoryKey = null; // for visual highlight

    const MAX_DETAIL_PHOTOS = 3;
    const MAX_ITEMS_MULTI = 8;

    const LOCAL_HISTORY_KEY = "estate_ai_local_history_v2_textonly";
    const LOCAL_HISTORY_LIMIT = 25;

    // =========================
    // Helpers
    // =========================
    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function safeString(x) {
      if (x == null) return "";
      if (typeof x === "string") return x;
      try { return JSON.stringify(x); } catch { return String(x); }
    }

    function nowIso() {
      return new Date().toISOString();
    }

    function formatTime(iso) {
      try { return new Date(iso).toLocaleString(); }
      catch { return iso; }
    }

    function money(n) {
      if (n == null || n === "") return "—";
      const num = Number(n);
      if (Number.isFinite(num)) return `$${num}`;
      return safeString(n);
    }

    function moneyRange(objOrNum) {
      // Accepts:
      // - number: 15
      // - string: "15-20"
      // - object: {low, high} or {min, max}
      if (objOrNum == null || objOrNum === "") return "—";

      if (typeof objOrNum === "number") return money(objOrNum);
      if (typeof objOrNum === "string") {
        // normalize "$15-$20" etc if already human
        return objOrNum.includes("$") ? objOrNum : objOrNum.replace(/\s+/g, " ").trim();
      }
      if (typeof objOrNum === "object") {
        const low = objOrNum.low ?? objOrNum.min;
        const high = objOrNum.high ?? objOrNum.max;
        if (low != null && high != null) return `${money(low)} – ${money(high)}`;
        if (low != null) return money(low);
        if (high != null) return money(high);
      }
      return safeString(objOrNum);
    }

    async function readJsonOrText(resp) {
      const ct = resp.headers.get("content-type") || "";
      if (ct.includes("application/json")) return await resp.json();
      const text = await resp.text();
      try { return JSON.parse(text); } catch { return { detail: text }; }
    }

    function setStatusOk(text) {
      statusEl.innerHTML = `<span class="ok">${escapeHtml(text)}</span>`;
    }
    function setStatusErr(text) {
      statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(safeString(text))}`;
    }

    // =========================
    // Mode selection (forced)
    // =========================
    function setMode(mode) {
      analysisMode = mode;

      modeOneWrap.classList.toggle("selected", mode === "single");
      modeManyWrap.classList.toggle("selected", mode === "multi");

      // enable analyze button only after mode + main photo is ready
      updateAnalyzeEnabled();
    }

    function ensureModeChosen() {
      if (!analysisMode) {
        setStatusErr("Please choose One Item or Many Items first.");
        return false;
      }
      return true;
    }

    function openInfo(mode) {
      if (mode === "single") {
        modalTitle.textContent = "One Item";
        modalBody.innerHTML = `
          Use <b>One Item</b> when your main photo shows one primary object (like a vase, a single book, a watch).<br/><br/>
          You can still add detail photos for markings, stamps, signatures, labels, and close-ups.
        `;
      } else {
        modalTitle.textContent = "Many Items";
        modalBody.innerHTML = `
          Use <b>Many Items</b> when your photo shows multiple objects and you want separate identification + a bundle estimate.<br/><br/>
          Tip: For best results, keep it under <b>${MAX_ITEMS_MULTI}</b> distinct items and make sure objects are clearly visible.
        `;
      }
      modalBackdrop.style.display = "flex";
    }

    function closeInfo() {
      modalBackdrop.style.display = "none";
    }

    // =========================
    // Local history (text-only to avoid storage quota)
    // =========================
    function readLocalHistory() {
      try {
        const raw = localStorage.getItem(LOCAL_HISTORY_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function writeLocalHistory(items) {
      localStorage.setItem(LOCAL_HISTORY_KEY, JSON.stringify(items));
    }

    function addToLocalHistory(entry) {
      const items = readLocalHistory();
      items.unshift(entry);
      writeLocalHistory(items.slice(0, LOCAL_HISTORY_LIMIT));
      renderLocalHistory();
    }

    function clearLocalHistory() {
      localStorage.removeItem(LOCAL_HISTORY_KEY);
      renderLocalHistory();
      statusEl.textContent = "";
      resultEl.innerHTML = "";
      rawWrap.style.display = "none";
      rawJson.textContent = "";
    }

    // =========================
    // Photos
    // =========================
    function openCamera() {
      cameraInput.value = "";
      cameraInput.click();
    }

    function openGallery() {
      galleryInput.value = "";
      galleryInput.click();
    }

    function openDetail() {
      if (!mainFile) {
        setStatusErr("Add a main photo first.");
        return;
      }
      if (detailFiles.length >= MAX_DETAIL_PHOTOS) {
        setStatusErr(`Max detail photos reached (${MAX_DETAIL_PHOTOS}).`);
        return;
      }
      detailInput.value = "";
      detailInput.click();
    }

    function updateAnalyzeEnabled() {
      analyzeBtn.disabled = !(analysisMode && mainFile && mainDataUrl);
    }

    function setMainFile(file) {
      if (!file) return;

      mainFile = file;
      mainDataUrl = null;

      // clear results
      statusEl.textContent = "";
      resultEl.innerHTML = "";
      rawWrap.style.display = "none";
      rawJson.textContent = "";

      // preview
      if (mainObjectUrl) URL.revokeObjectURL(mainObjectUrl);
      mainObjectUrl = URL.createObjectURL(file);

      preview.src = mainObjectUrl;
      preview.style.display = "block";
      previewHint.textContent = "Loading image…";

      analyzeBtn.disabled = true;

      const reader = new FileReader();
      reader.onload = () => {
        mainDataUrl = reader.result;
        previewHint.textContent = "Ready to analyze.";
        updateAnalyzeEnabled();
      };
      reader.onerror = () => {
        previewHint.textContent = "Could not read image.";
        updateAnalyzeEnabled();
      };
      reader.readAsDataURL(file);
    }

    function addDetailFile(file) {
      if (!file) return;
      if (detailFiles.length >= MAX_DETAIL_PHOTOS) return;

      detailFiles.push(file);

      const reader = new FileReader();
      reader.onload = () => {
        detailDataUrls.push(reader.result);
        renderDetailStrip();
      };
      reader.onerror = () => renderDetailStrip();
      reader.readAsDataURL(file);

      renderDetailStrip();
    }

    function removeDetailAt(i) {
      detailFiles.splice(i, 1);
      detailDataUrls.splice(i, 1);
      renderDetailStrip();
    }

    function renderDetailStrip() {
      if (!detailFiles.length) {
        detailStrip.style.display = "none";
        detailStrip.innerHTML = "";
        return;
      }
      detailStrip.style.display = "flex";
      detailStrip.innerHTML = "";

      detailFiles.forEach((f, idx) => {
        const url = URL.createObjectURL(f);
        const chip = document.createElement("div");
        chip.className = "thumbChip";
        chip.innerHTML = `
          <div class="chipLabel">
            <span>Detail ${idx + 1}</span>
            <button class="removeX" title="Remove" onclick="removeDetailAt(${idx})">×</button>
          </div>
          <img src="${escapeHtml(url)}" alt="detail" />
        `;
        detailStrip.appendChild(chip);
      });
    }

    cameraInput.addEventListener("change", () => setMainFile(cameraInput.files?.[0]));
    galleryInput.addEventListener("change", () => setMainFile(galleryInput.files?.[0]));
    detailInput.addEventListener("change", () => addDetailFile(detailInput.files?.[0]));

    // =========================
    // Rendering results (new JSON format)
    // Expected:
    // data = { scan_id, created_at, analysis_mode, result: { items: [...], bundle_price_range?, advice? } }
    // items[i] may have estimated_price = number OR {low,high}
    // =========================
    function renderResultEnvelope(envelope) {
      // show raw json always (helps debugging + trust)
      rawWrap.style.display = "block";
      rawJson.textContent = JSON.stringify(envelope, null, 2);

      const r = envelope?.result || envelope; // allow direct result fallback
      const items = Array.isArray(r?.items) ? r.items : [];

      if (!items.length) {
        const msg = r?.pricing_estimates || "No items detected. Try a closer/brighter photo or check raw JSON.";
        resultEl.innerHTML = `
          <div class="resultCard">
            <div class="resultHead">
              <div class="itemTitle">Result</div>
            </div>
            <div style="margin-top:8px; color:#222;">${escapeHtml(msg)}</div>
          </div>
        `;
        return;
      }

      // bundle price range
      const bundle = r?.bundle_price_range;
      const bundleText = moneyRange(bundle);

      // advice array or advisory tips
      const advice = Array.isArray(r?.advice) ? r.advice
                   : Array.isArray(r?.advisory?.tips) ? r.advisory.tips
                   : [];

      const adviceHtml = advice.length
        ? `<div style="margin-top:10px; color:#222;"><b>Notes:</b><ul>${advice.map(a => `<li>${escapeHtml(a)}</li>`).join("")}</ul></div>`
        : "";

      // render item cards
      resultEl.innerHTML = items.map((it) => {
        const name = it?.name || it?.title || "Item";
        const est = it?.estimated_price;
        const estText = moneyRange(est);

        // some responses may include suggested_list_price, suggested_listing_price, etc.
        const suggested =
          it?.suggested_listing_price ??
          it?.suggested_list_price ??
          it?.list_price ??
          null;

        const suggestedText = (suggested && typeof suggested === "object")
          ? moneyRange(suggested)
          : money(suggested);

        const detailsText = it?.details || it?.description || "";
        const conditionText = it?.condition || it?.condition_notes || "";

        return `
          <div class="resultCard" style="margin-bottom:12px;">
            <div class="resultHead">
              <div class="itemTitle">${escapeHtml(name)}</div>
              <span class="pill">Shared with your team</span>
            </div>

            <div class="metrics">
              <div class="metricBox">
                <div class="metricLabel">Suggested listing price</div>
                <div class="metricValue">${escapeHtml(suggestedText)}</div>
              </div>
              <div class="metricBox">
                <div class="metricLabel">Bundle / range</div>
                <div class="metricValue">${escapeHtml(bundleText)}</div>
              </div>
            </div>

            ${(conditionText || detailsText) ? `
              <div style="margin-top:10px; color:#222; font-size:13px; line-height:1.3;">
                ${conditionText ? `<b>Condition:</b> ${escapeHtml(conditionText)}<br/>` : ""}
                ${detailsText ? `<b>Details:</b> ${escapeHtml(detailsText)}` : ""}
              </div>
            ` : ""}

            ${adviceHtml}
          </div>
        `;
      }).join("");
    }

    // =========================
    // Team History (shared)
    // Backend returns: { items: [ {scan_id, created_at, image_url, result, analysis_mode} ] }
    // Each item.result is the result object (contains items[] etc)
    // =========================
    function clearHistorySelection() {
      document.querySelectorAll(".historyItem.selected").forEach(el => el.classList.remove("selected"));
    }

    function renderTeamHistory(items) {
      teamHistoryEl.innerHTML = "";
      if (!items || !items.length) {
        teamEmptyEl.style.display = "block";
        return;
      }
      teamEmptyEl.style.display = "none";

      items.forEach((item) => {
        const r = item?.result || {};
        const first = Array.isArray(r?.items) && r.items.length ? r.items[0] : null;
        const title = first?.name || first?.title || item?.title || "Scan";
        const time = item?.created_at ? formatTime(item.created_at) : "";
        const imgSrc = item?.image_url || "";

        const div = document.createElement("div");
        div.className = "historyItem";

        div.onclick = () => {
          clearHistorySelection();
          div.classList.add("selected");

          // load preview from server image
          if (imgSrc) {
            preview.src = imgSrc;
            preview.style.display = "block";
            previewHint.textContent = "Loaded from team history.";
          }

          setStatusOk("Loaded ✅");

          // display the envelope-like structure so raw JSON shows scan_id etc
          renderResultEnvelope({
            scan_id: item.scan_id,
            created_at: item.created_at,
            analysis_mode: item.analysis_mode,
            result: item.result
          });
        };

        div.innerHTML = `
          <img class="thumb" src="${escapeHtml(imgSrc)}" alt="thumb" />
          <div class="historyMeta">
            <div class="title">${escapeHtml(title)}</div>
            <div class="time">${escapeHtml(time)}</div>
            <div class="sharedPill">
              <span class="pill">Shared with your team</span>
            </div>
          </div>
        `;
        teamHistoryEl.appendChild(div);
      });
    }

    async function refreshTeamHistory() {
      try {
        const resp = await fetch("/history?limit=25");
        if (!resp.ok) return;
        const data = await resp.json();
        renderTeamHistory(data.items || []);
      } catch (e) {
        console.error(e);
      }
    }

    // =========================
    // Local History (text only)
    // =========================
    function renderLocalHistory() {
      const items = readLocalHistory();
      historyEl.innerHTML = "";

      if (!items.length) {
        historyEmptyEl.style.display = "block";
        return;
      }
      historyEmptyEl.style.display = "none";

      items.forEach((item, idx) => {
        const first = Array.isArray(item?.result?.result?.items) && item.result.result.items.length
          ? item.result.result.items[0]
          : null;

        const title = first?.name || first?.title || "Scan";
        const time = item?.created_at ? formatTime(item.created_at) : "";

        const div = document.createElement("div");
        div.className = "historyItem";
        div.onclick = () => {
          clearHistorySelection();
          div.classList.add("selected");

          // local history does NOT store images (avoids quota issues)
          previewHint.textContent = "Loaded from local history (no local thumbnail saved).";

          setStatusOk("Loaded ✅");
          renderResultEnvelope(item.result);
        };

        div.innerHTML = `
          <img class="thumb" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96'%3E%3Crect width='100%25' height='100%25' fill='%23f1f1f1'/%3E%3Ctext x='50%25' y='52%25' font-size='12' text-anchor='middle' fill='%23999'%3ENo image%3C/text%3E%3C/svg%3E" alt="thumb" />
          <div class="historyMeta">
            <div class="title">${escapeHtml(title)}</div>
            <div class="time">${escapeHtml(time)}</div>
          </div>
        `;
        historyEl.appendChild(div);
      });
    }

    // =========================
    // Analyze
    // Sends: main photo + optional detail photos + analysis_mode
    // Backend expected to accept:
    // - file (main)
    // - detail_files (0..3)
    // - analysis_mode ('single'|'multi')
    // =========================
    async function analyze() {
      if (!ensureModeChosen()) return;

      if (!mainFile) {
        setStatusErr("Select a main photo first.");
        return;
      }
      if (!mainDataUrl) {
        setStatusErr("Please wait—image still loading.");
        return;
      }

      analyzeBtn.disabled = true;
      statusEl.textContent = "Analyzing…";
      resultEl.innerHTML = "";
      rawWrap.style.display = "none";
      rawJson.textContent = "";

      const formData = new FormData();
      formData.append("file", mainFile);
      formData.append("analysis_mode", analysisMode);

      // detail photos
      detailFiles.forEach((f) => formData.append("detail_files", f));

      try {
        const resp = await fetch("/analyze-image", { method: "POST", body: formData });
        const data = await readJsonOrText(resp);

        if (!resp.ok) {
          // prefer {error, details} or {detail}
          const msg = data?.error || data?.detail || data?.message || `Server error ${resp.status}`;
          const details = data?.details ? `\n\nDetails: ${safeString(data.details)}` : "";
          throw new Error(safeString(msg) + details);
        }

        setStatusOk("Done ✅");

        // show results (supports envelope)
        renderResultEnvelope(data);

        // save a text-only history entry
        addToLocalHistory({
          created_at: nowIso(),
          result: data
        });

        // refresh team history
        await refreshTeamHistory();

      } catch (e) {
        console.error(e);
        setStatusErr(e?.message || e);
        resultEl.innerHTML = "";
      } finally {
        analyzeBtn.disabled = false;
        updateAnalyzeEnabled();
      }
    }

    // =========================
    // Init
    // =========================
    // Default: no mode chosen (forced)
    setMode(null); // clears selection

    renderLocalHistory();
    refreshTeamHistory();
    updateAnalyzeEnabled();

    // Make sure clicking the fake “boxes” doesn’t show checks before selection
    modeOneWrap.classList.remove("selected");
    modeManyWrap.classList.remove("selected");
  </script>
</body>
</html>
