<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Estate AI Scanner</title>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 16px;
  max-width: 1100px;
  margin: 0 auto;
}

h1 { margin-bottom: 6px; }
.sub { color: #555; margin-bottom: 16px; }

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
}

button {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
}

button.primary {
  background: #2b7cff;
  color: #fff;
  border-color: #2b7cff;
  font-weight: bold;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

@media (max-width: 900px) {
  .grid {
    grid-template-columns: 1fr;
  }
}

.card {
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 12px;
  background: #fff;
}

/* FIXED PREVIEW BEHAVIOR */
#previewContainer {
  width: 100%;
  max-height: 420px;
  overflow: hidden;
  border-radius: 10px;
  border: 1px solid #eee;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fafafa;
}

#preview {
  max-width: 100%;
  max-height: 420px;
  object-fit: contain;
}

.previewStrip {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}

.previewThumb {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 6px;
  border: 1px solid #ddd;
}

.status { margin-top: 8px; }
.ok { color: green; font-weight: bold; }
.err { color: red; font-weight: bold; }

.resultLine { margin: 6px 0; }

.tipBox {
  margin-top: 14px;
  font-size: 13px;
  background: #f6f6f6;
  padding: 8px;
  border-radius: 8px;
}
</style>
</head>

<body>

<h1>Estate AI Scanner</h1>
<p class="sub">Snap a photo, identify the item(s), and get an estimate.</p>

<input id="cameraInput" type="file" accept="image/*" capture="environment" hidden />
<input id="galleryInput" type="file" accept="image/*" hidden />
<input id="extraInput" type="file" accept="image/*" multiple hidden />

<div class="controls">
  <button onclick="openCamera()">Use Camera</button>
  <button onclick="openGallery()">Choose From Photos</button>
  <button onclick="addDetail()">Add Detail Photo</button>

  <label>
    <input type="radio" name="mode" value="single" checked>
    Single / Bundle
  </label>

  <label>
    <input type="radio" name="mode" value="multi">
    Multi (max 8)
  </label>

  <button class="primary" onclick="analyze()">Analyze</button>
</div>

<div class="grid">

  <div class="card">
    <h3>Preview</h3>

    <div id="previewContainer">
      <img id="preview" />
    </div>

    <div id="previewStrip" class="previewStrip"></div>

    <div class="tipBox">
      Tip: Add close-up photos of stamps, markings, signatures, or edges.
      If results are unclear, take a brighter and closer photo.
    </div>
  </div>

  <div class="card">
    <h3>Result</h3>
    <div id="status" class="status"></div>
    <div id="result"></div>
  </div>

</div>

<script>

const cameraInput = document.getElementById("cameraInput");
const galleryInput = document.getElementById("galleryInput");
const extraInput = document.getElementById("extraInput");

const preview = document.getElementById("preview");
const previewStrip = document.getElementById("previewStrip");
const statusEl = document.getElementById("status");
const resultEl = document.getElementById("result");

let selectedFiles = [];
let previewUrls = [];

function openCamera() { cameraInput.click(); }
function openGallery() { galleryInput.click(); }
function addDetail() { extraInput.click(); }

cameraInput.onchange = e => addFiles(e.target.files);
galleryInput.onchange = e => {
  selectedFiles = [];
  previewUrls.forEach(u => URL.revokeObjectURL(u));
  previewUrls = [];
  addFiles(e.target.files);
};
extraInput.onchange = e => addFiles(e.target.files);

function addFiles(files) {
  for (let file of files) {
    if (selectedFiles.length >= 4) break;
    selectedFiles.push(file);
    const url = URL.createObjectURL(file);
    previewUrls.push(url);
  }
  renderPreview();
}

function renderPreview() {
  if (previewUrls.length > 0) {
    preview.src = previewUrls[0];
  }
  previewStrip.innerHTML = "";
  previewUrls.forEach(url => {
    const img = document.createElement("img");
    img.src = url;
    img.className = "previewThumb";
    previewStrip.appendChild(img);
  });
}

async function analyze() {

  if (selectedFiles.length === 0) {
    statusEl.innerHTML = '<span class="err">Select a photo first.</span>';
    return;
  }

  statusEl.innerHTML = "Analyzing...";
  resultEl.innerHTML = "";

  const formData = new FormData();

  selectedFiles.forEach(f => formData.append("images", f));

  const mode = document.querySelector('input[name="mode"]:checked').value;
  formData.append("analysis_mode", mode);

  try {
    const res = await fetch("/analyze-image", {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    if (!res.ok) {
      statusEl.innerHTML = '<span class="err">Error</span>';
      resultEl.innerText = JSON.stringify(data);
      return;
    }

    statusEl.innerHTML = '<span class="ok">Done âœ”</span>';
    resultEl.innerHTML = `<pre>${JSON.stringify(data.result, null, 2)}</pre>`;

  } catch (e) {
    statusEl.innerHTML = '<span class="err">Error</span>';
    resultEl.innerText = e.message;
  }

}

</script>
</body>
</html>
