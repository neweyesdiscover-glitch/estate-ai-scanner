<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Estate AI Scanner</title>
  <style>
    body { font-family: Arial; padding: 40px; max-width: 1000px; margin: 0 auto; }
    h1 { margin-bottom: 6px; }
    .sub { color: #555; margin-top: 0; }

    .row { display: flex; gap: 24px; align-items: flex-start; margin-top: 18px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; background: #fff; }
    .left { width: 320px; }
    .right { flex: 1; }

    .controls { display: flex; gap: 10px; align-items: center; margin-top: 12px; }
    button { padding: 8px 12px; cursor: pointer; }

    #previewImg {
      width: 100%;
      max-height: 420px;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid #eee;
      display: none;
      margin-top: 10px;
    }

    .status { margin: 10px 0 0; color: #333; }
    .error { color: #b00020; font-weight: 600; }

    /* Tight spacing for result lines */
    .resultLine { margin: 6px 0; line-height: 1.25; }
    .label { font-weight: 700; }

    ul { margin: 6px 0 0 18px; padding: 0; }
    li { margin: 2px 0; }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #f7f7f7;
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <h1>Estate AI Scanner</h1>
  <p class="sub">Upload an item to get an instant resale estimate.</p>

  <div class="controls">
    <input id="fileInput" type="file" accept="image/*" />
    <button id="analyzeBtn" onclick="upload()">Analyze Item</button>
  </div>

  <div class="row">
    <div class="card left">
      <h3 style="margin:0 0 6px;">Preview</h3>
      <div style="color:#666; font-size: 14px;">Selected image will appear here.</div>
      <img id="previewImg" alt="Preview" />
    </div>

    <div class="card right">
      <h3 style="margin:0 0 6px;">Result</h3>
      <div id="miniStatus" class="status"></div>
      <div id="result"></div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const previewImg = document.getElementById("previewImg");
    const resultEl = document.getElementById("result");
    const miniStatus = document.getElementById("miniStatus");
    const analyzeBtn = document.getElementById("analyzeBtn");

    // Show image preview immediately when selected
    fileInput.addEventListener("change", () => {
      resultEl.innerHTML = "";
      miniStatus.textContent = "";

      const file = fileInput.files?.[0];
      if (!file) {
        previewImg.style.display = "none";
        previewImg.src = "";
        return;
      }

      const url = URL.createObjectURL(file);
      previewImg.src = url;
      previewImg.style.display = "block";
    });

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function parseMaybeJson(raw) {
      try { return JSON.parse(raw); } catch { return null; }
    }

    function renderResultFromJson(obj) {
      // Expected keys from your backend prompt:
      // item_name, brand_or_origin, estimated_value_range, suggested_listing_price,
      // condition_assumptions, keywords_for_listing, pricing_sources

      const pricingSources = obj.pricing_sources;
      const sourcesArr = Array.isArray(pricingSources)
        ? pricingSources
        : (typeof pricingSources === "string" && pricingSources.trim()
            ? pricingSources.split(",").map(s => s.trim()).filter(Boolean)
            : []);

      const keywords = obj.keywords_for_listing;
      const keywordsText = Array.isArray(keywords) ? keywords.join(", ") : (keywords ?? "");

      resultEl.innerHTML = `
        <div class="resultLine"><span class="label">Item:</span> ${escapeHtml(obj.item_name ?? "")}</div>
        <div class="resultLine"><span class="label">Brand/Origin:</span> ${escapeHtml(obj.brand_or_origin ?? "")}</div>
        <div class="resultLine"><span class="label">Estimated Price Range:</span> ${escapeHtml(obj.estimated_value_range ?? "")}</div>
        <div class="resultLine"><span class="label">Suggested Listing Price:</span> ${escapeHtml(obj.suggested_listing_price ?? "")}</div>
        <div class="resultLine"><span class="label">Condition:</span> ${escapeHtml(obj.condition_assumptions ?? "")}</div>
        <div class="resultLine"><span class="label">Keywords:</span> ${escapeHtml(keywordsText)}</div>

        ${sourcesArr.length ? `
          <div class="resultLine" style="margin-top:10px;">
            <span class="label">Pricing Sources:</span>
            <ul>
              ${sourcesArr.map(s => `<li>${escapeHtml(s)}</li>`).join("")}
            </ul>
          </div>
        ` : ""}
      `;
    }

    async function upload() {
      const file = fileInput.files?.[0];
      if (!file) {
        alert("Please select an image first.");
        return;
      }

      analyzeBtn.disabled = true;
      miniStatus.textContent = "Analyzing…";
      resultEl.innerHTML = "";

      const formData = new FormData();
      formData.append("file", file);

      try {
        // ✅ RELATIVE PATH (works locally + Render when frontend is served by the same FastAPI app)
        const response = await fetch("/analyze-image", {
          method: "POST",
          body: formData
        });

        const text = await response.text();

        if (!response.ok) {
          throw new Error(`Server error ${response.status}: ${text}`);
        }

        // Backend returns: { "raw": "..." }
        const payload = JSON.parse(text);
        const raw = payload.raw ?? "";

        // Try to parse raw JSON the model returned
        const parsed = parseMaybeJson(raw);

        miniStatus.textContent = "Done ✅";

        if (parsed && typeof parsed === "object") {
          renderResultFromJson(parsed);
        } else {
          // Fallback: show raw text
          resultEl.innerHTML = `<pre>${escapeHtml(raw)}</pre>`;
        }

      } catch (err) {
        console.error(err);
        miniStatus.textContent = "";
        resultEl.innerHTML = `<div class="error">Connection error. ${escapeHtml(err.message)}</div>`;
      } finally {
        analyzeBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
