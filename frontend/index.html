<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Estate AI Scanner</title>
    <style>
      body { font-family: Arial; padding: 40px; max-width: 1000px; }
      .row { display: flex; gap: 20px; margin-top: 20px; }
      .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; width: 50%; }
      img { max-width: 100%; border-radius: 10px; }
      pre { white-space: pre-wrap; word-wrap: break-word; }
      .error { color: #b00020; font-weight: bold; }
      .ok { color: #0a7a0a; font-weight: bold; }
      button { padding: 8px 14px; }
    </style>
  </head>

  <body>
    <h1>Estate AI Scanner</h1>
    <p>Upload an item to get an instant resale estimate.</p>

    <input id="fileInput" type="file" accept="image/*" />
    <button id="analyzeBtn" onclick="upload()">Analyze Item</button>

    <div class="row">
      <div class="card">
        <h3>Preview</h3>
        <p style="color:#666;">Selected image will appear here.</p>
        <img id="preview" style="display:none;" />
      </div>

      <div class="card">
        <h3>Result</h3>
        <div id="miniStatus" style="color:#666;">Waiting…</div>
        <div id="result"></div>
      </div>
    </div>

    <script>
      const fileInput = document.getElementById("fileInput");
      const preview = document.getElementById("preview");
      const resultEl = document.getElementById("result");
      const miniStatus = document.getElementById("miniStatus");
      const analyzeBtn = document.getElementById("analyzeBtn");

      fileInput.addEventListener("change", () => {
        const file = fileInput.files?.[0];
        if (!file) return;
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
      });

      async function upload() {
        const file = fileInput.files?.[0];
        if (!file) {
          miniStatus.textContent = "Please choose an image first.";
          return;
        }

        analyzeBtn.disabled = true;
        miniStatus.textContent = "Analyzing…";
        resultEl.innerHTML = "";

        const formData = new FormData();
        formData.append("file", file);

        try {
          // Relative path = same host (works on Render + local)
          const response = await fetch("/analyze-image", {
            method: "POST",
            body: formData
          });

          const text = await response.text();

          if (!response.ok) {
            throw new Error(`Server error ${response.status}: ${text}`);
          }

          // Try parse JSON from backend
          // (Backend returns JSON; this also handles any accidental code fences)
          let cleaned = text.replace(/```json|```/g, "").trim();
          let data;
          try {
            data = JSON.parse(cleaned);
          } catch (e) {
            throw new Error("Could not parse JSON from server:\n" + text);
          }

          if (data.error) {
            miniStatus.innerHTML = `<span class="error">Error:</span> ${data.error}`;
            resultEl.innerHTML = `<pre>${escapeHtml(data.raw || "")}</pre>`;
            return;
          }

          miniStatus.innerHTML = `<span class="ok">Done ✅</span>`;
          resultEl.innerHTML = `<pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;

        } catch (err) {
          miniStatus.innerHTML = `<span class="error">Connection error.</span> ${escapeHtml(err.message)}`;
          resultEl.innerHTML = "";
        } finally {
          analyzeBtn.disabled = false;
        }
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
    </script>
  </body>
</html>
