<!-- frontend/index.html
     ✅ Estate AI Scanner — Camera + Local History + Shared Team History
     - NO login logic in frontend (backend handles /login redirect)
     - "Use Camera" opens rear camera on phones
     - Local History saved per device (localStorage) — TEXT ONLY (no base64 images; avoids quota)
     - Team History pulled from server (shared) — includes thumbnails from backend
     - Team History tap-proofing + selection highlight + auto-scroll to results
     - Result UI standardized to NEW JSON format + Confidence UX upgrade
-->

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estate AI Scanner</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 6px; }
    .sub { margin: 0 0 16px; color: #555; }

    .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin: 10px 0 18px; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button.primary { background: #2b7cff; color: #fff; border-color: #2b7cff; font-weight: 700; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .grid { display: grid; grid-template-columns: 360px 1fr; gap: 18px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; background: #fff; }
    .card h3 { margin: 0 0 10px; }

    #preview {
      width: 100%;
      max-height: 520px;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid #eee;
      display: none;
    }

    .status { margin: 8px 0 0; color: #666; font-size: 13px; }
    .ok { color: #0a7a0a; font-weight: 700; }
    .err { color: #b00020; font-weight: 700; }

    .resultLine { margin: 6px 0; line-height: 1.25; }
    .label { font-weight: 800; }

    .historyList { display: flex; flex-direction: column; gap: 10px; }
    .historyItem {
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 10px;
      align-items: center;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 8px;
      cursor: pointer;
      transition: transform 0.05s ease;
    }
    .historyItem:hover { background: #fafafa; }
    .historyItem:active { transform: scale(0.99); }

    .thumb {
      width: 72px; height: 72px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #eee;
      display: block;
      background: #f7f7f7;
      /* Tap-proofing: thumbnail should not intercept taps */
      pointer-events: none;
    }
    .thumbPlaceholder {
      width: 72px; height: 72px;
      border-radius: 8px;
      border: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f7f7f7;
      color: #777;
      font-size: 12px;
      user-select: none;
      pointer-events: none;
    }

    .historyMeta { font-size: 13px; color: #444; }
    .historyMeta .title { font-weight: 800; color: #111; margin-bottom: 2px; }
    .historyMeta .time { color: #666; font-size: 12px; }

    /* Small badge for Team History cards */
    .badge {
      display: inline-block;
      font-size: 11px;
      color: #2b7cff;
      background: rgba(43, 124, 255, 0.10);
      border: 1px solid rgba(43, 124, 255, 0.25);
      padding: 2px 6px;
      border-radius: 999px;
      margin-top: 6px;
    }

    /* Visual selection highlight */
    .historyItem.selected {
      border-color: #2b7cff;
      box-shadow: 0 0 0 2px rgba(43, 124, 255, 0.18);
      background: #f4f8ff;
    }

    /* Confidence UX */
    .confWrap { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin: 10px 0 6px; }
    .confPill {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 12px;
      border: 1px solid #ddd;
      background: #f7f7f7;
      color: #333;
    }
    .confPill strong { font-weight: 800; }
    .confHigh { border-color: rgba(10, 122, 10, 0.35); background: rgba(10, 122, 10, 0.08); color: #0a7a0a; }
    .confMed  { border-color: rgba(176, 112, 0, 0.35); background: rgba(176, 112, 0, 0.08); color: #7a4a00; }
    .confLow  { border-color: rgba(176, 0, 32, 0.30); background: rgba(176, 0, 32, 0.06); color: #b00020; }
    .confTip {
      font-size: 12px;
      color: #555;
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      margin: 8px 0 0;
    }
    .confTip ul { margin: 6px 0 0 18px; }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #f7f7f7;
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0 0;
    }

    .small { font-size: 12px; color: #666; margin-top: 10px; }
  </style>
</head>

<body>
  <h1>Estate AI Scanner</h1>
  <p class="sub" id="subtitle">Snap a photo, identify the item, and get an estimate.(v1.0.3)</p>

  <!-- Hidden inputs: Camera + Gallery -->
  <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none" />
  <input id="galleryInput" type="file" accept="image/*" style="display:none" />

  <div class="controls">
    <button onclick="openCamera()">Use Camera</button>
    <button onclick="openGallery()">Choose From Photos</button>
    <button id="analyzeBtn" class="primary" onclick="analyze()">Analyze</button>

    <button onclick="refreshTeamHistory()">Refresh Team History</button>
    <button onclick="clearLocalHistory()">Clear Local History</button>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Preview</h3>
      <img id="preview" alt="Preview" />
      <div id="previewHint" class="status">Select a photo to begin.</div>

      <div class="small">
        Tip: On phones, “Use Camera” should open the rear camera automatically.
      </div>
    </div>

    <div class="card">
      <h3>Result</h3>
      <div id="status" class="status"></div>
      <div id="result"></div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <h3>Team History (shared)</h3>
      <div id="teamHistory" class="historyList"></div>
      <div id="teamEmpty" class="status">No team scans yet.</div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <h3>Local History (this device)</h3>
      <div id="history" class="historyList"></div>
      <div id="historyEmpty" class="status">No local scans saved yet.</div>
      <div class="small">Note: Local history stores results only (no photos) to avoid storage limits on phones.</div>
    </div>
  </div>

  <script>
    // =========================
    // Elements
    // =========================
    const cameraInput = document.getElementById("cameraInput");
    const galleryInput = document.getElementById("galleryInput");
    const preview = document.getElementById("preview");
    const previewHint = document.getElementById("previewHint");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const analyzeBtn = document.getElementById("analyzeBtn");

    const historyEl = document.getElementById("history");
    const historyEmptyEl = document.getElementById("historyEmpty");

    const teamHistoryEl = document.getElementById("teamHistory");
    const teamEmptyEl = document.getElementById("teamEmpty");

    // =========================
    // Local state
    // =========================
    let selectedFile = null;
    let selectedDataUrl = null; // used only for current preview during selection
    let lastObjectUrl = null;

    const LOCAL_HISTORY_KEY = "estate_ai_local_history_v1";
    const LOCAL_HISTORY_LIMIT = 25;

    // =========================
    // Helpers
    // =========================
    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function nowIso() {
      return new Date().toISOString();
    }

    function formatTime(iso) {
      try { return new Date(iso).toLocaleString(); }
      catch { return iso; }
    }

    function stripCodeFences(s) {
      return String(s ?? "").replace(/```json|```/gi, "").trim();
    }

    async function readJsonOrText(resp) {
      const ct = resp.headers.get("content-type") || "";
      if (ct.includes("application/json")) return await resp.json();
      const text = await resp.text();
      try { return JSON.parse(stripCodeFences(text)); } catch { return { detail: text }; }
    }

    function extractResult(payload) {
      // Backend returns: { scan_id, created_at, company_code, result: {...} }
      if (payload && typeof payload === "object" && payload.result && typeof payload.result === "object") {
        return payload.result;
      }
      // Fallback if backend returns result object directly
      return payload;
    }

    function fmtUsd(n) {
      const num = Number(n);
      if (!isFinite(num)) return "";
      try {
        return new Intl.NumberFormat(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 0 }).format(num);
      } catch {
        return `$${Math.round(num)}`;
      }
    }

    // =========================
    // Local history (device) — TEXT ONLY
    // =========================
    function readLocalHistory() {
      try {
        const raw = localStorage.getItem(LOCAL_HISTORY_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function writeLocalHistory(items) {
      localStorage.setItem(LOCAL_HISTORY_KEY, JSON.stringify(items));
    }

    function addToLocalHistory(entry) {
      const items = readLocalHistory();
      items.unshift(entry);
      writeLocalHistory(items.slice(0, LOCAL_HISTORY_LIMIT));
      renderLocalHistory();
    }

    function clearLocalHistory() {
      localStorage.removeItem(LOCAL_HISTORY_KEY);
      renderLocalHistory();
      statusEl.textContent = "";
      resultEl.innerHTML = "";
      preview.style.display = "none";
      previewHint.textContent = "Local history cleared.";
    }

    // =========================
    // Result UI (STANDARDIZED NEW JSON) + Confidence UX
    // =========================
    function renderResult(payloadOrResult) {
      const data = extractResult(payloadOrResult);

      if (!data || typeof data !== "object") {
        resultEl.innerHTML = `<pre>${escapeHtml(String(data))}</pre>`;
        return;
      }

      if (data.error) {
        statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(data.error)}`;
        if (data.raw) resultEl.innerHTML = `<pre>${escapeHtml(data.raw)}</pre>`;
        return;
      }

      const title = (data.title ?? "").trim();
      const category = (data.category ?? "").trim();
      const condition = (data.condition_notes ?? "").trim();

      const low = (data.price_range_low != null && data.price_range_low !== "") ? Number(data.price_range_low) : null;
      const high = (data.price_range_high != null && data.price_range_high !== "") ? Number(data.price_range_high) : null;
      const listPrice = (data.suggested_list_price != null && data.suggested_list_price !== "") ? Number(data.suggested_list_price) : null;

      const keywords = Array.isArray(data.keywords) ? data.keywords.filter(Boolean) : [];
      const rationale = data.rationale ?? "";
      const rationaleText = Array.isArray(rationale) ? rationale.join("\n") : String(rationale || "");

      // Confidence UX
      let confPct = null;
      if (typeof data.confidence === "number" && isFinite(data.confidence)) {
        confPct = Math.max(0, Math.min(100, Math.round(data.confidence * 100)));
      }

      let confLabel = "";
      let confClass = "";
      let confTip = "";

      if (confPct != null) {
        if (confPct >= 75) {
          confLabel = "High";
          confClass = "confHigh";
          confTip = "";
        } else if (confPct >= 45) {
          confLabel = "Medium";
          confClass = "confMed";
          confTip = "If this looks off, retake the photo with better lighting or include the full item in frame.";
        } else {
          confLabel = "Low";
          confClass = "confLow";
          confTip = "Try a quick re-photo to improve accuracy:";
        }
      }

      const rangeStr =
        (low != null && high != null) ? `${fmtUsd(low)} – ${fmtUsd(high)}` :
        (low != null) ? `${fmtUsd(low)}+` :
        (high != null) ? `Up to ${fmtUsd(high)}` :
        "";

      const listStr = (listPrice != null) ? fmtUsd(listPrice) : "";

      resultEl.innerHTML = `
        <div class="resultLine"><span class="label">Item:</span> ${escapeHtml(title || "Unknown item")}</div>
        ${category ? `<div class="resultLine"><span class="label">Category:</span> ${escapeHtml(category)}</div>` : ""}
        ${condition ? `<div class="resultLine"><span class="label">Condition Notes:</span> ${escapeHtml(condition)}</div>` : ""}

        ${rangeStr ? `<div class="resultLine"><span class="label">Estimated Value Range:</span> ${escapeHtml(rangeStr)}</div>` : ""}
        ${listStr ? `<div class="resultLine"><span class="label">Suggested Listing Price:</span> ${escapeHtml(listStr)}</div>` : ""}

        ${confPct != null ? `
          <div class="confWrap">
            <div class="confPill ${confClass}">
              <strong>Confidence</strong>
              <span>${escapeHtml(String(confPct))}%</span>
              <span>(${escapeHtml(confLabel)})</span>
            </div>
          </div>
        ` : ""}

        ${keywords.length ? `<div class="resultLine"><span class="label">Keywords:</span> ${escapeHtml(keywords.join(", "))}</div>` : ""}

        ${rationaleText.trim()
          ? `<div class="resultLine" style="margin-top:10px;"><span class="label">Rationale:</span><pre>${escapeHtml(rationaleText)}</pre></div>`
          : ""
        }

        ${confPct != null && confPct < 45 ? `
          <div class="confTip">
            <div><strong>Low confidence:</strong> ${escapeHtml(confTip)}</div>
            <ul>
              <li>Include the entire item (not cropped)</li>
              <li>Get closer to brand labels / maker marks</li>
              <li>Use brighter lighting and reduce glare</li>
              <li>Take a second angle if needed</li>
            </ul>
          </div>
        ` : (confPct != null && confPct < 75 && confTip ? `
          <div class="confTip">${escapeHtml(confTip)}</div>
        ` : "")}
      `;
    }

    // =========================
    // Local History rendering (NEW JSON)
    // =========================
    function renderLocalHistory() {
      const items = readLocalHistory();
      historyEl.innerHTML = "";

      if (!items.length) {
        historyEmptyEl.style.display = "block";
        return;
      }
      historyEmptyEl.style.display = "none";

      items.forEach((item, idx) => {
        const r = item?.result || {};
        const title = (r?.title ?? "Unknown item").trim();
        const time = item?.created_at ? formatTime(item.created_at) : "";
        const price = (r?.suggested_list_price != null) ? fmtUsd(r.suggested_list_price) : "";
        const range = (r?.price_range_low != null && r?.price_range_high != null)
          ? `${fmtUsd(r.price_range_low)}–${fmtUsd(r.price_range_high)}`
          : "";

        const div = document.createElement("div");
        div.className = "historyItem";
        div.onclick = () => openLocalHistoryItem(idx);

        div.innerHTML = `
          <div class="thumbPlaceholder">No image</div>
          <div class="historyMeta">
            <div class="title">${escapeHtml(title)}</div>
            <div>${escapeHtml(range)} ${price ? " • " + escapeHtml(price) : ""}</div>
            <div class="time">${escapeHtml(time)}</div>
          </div>
        `;

        historyEl.appendChild(div);
      });
    }

    function openLocalHistoryItem(index) {
      const items = readLocalHistory();
      const item = items[index];
      if (!item) return;

      selectedFile = null;
      selectedDataUrl = null;

      preview.style.display = "none";
      previewHint.textContent = "Loaded from local history (no image stored on device).";

      statusEl.innerHTML = `<span class="ok">Loaded ✅</span>`;
      renderResult(item.result);
      resultEl.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // =========================
    // Team History (shared) — tap-proof + selection highlight + scroll (NEW JSON)
    // =========================
    function renderTeamHistory(items) {
      teamHistoryEl.innerHTML = "";
      if (!items || !items.length) {
        teamEmptyEl.style.display = "block";
        return;
      }
      teamEmptyEl.style.display = "none";

      items.forEach((item) => {
        const r = item?.result || {};
        const title = (r?.title ?? item?.title ?? "Unknown item").trim();
        const time = item?.created_at ? formatTime(item.created_at) : "";
        const price = (r?.suggested_list_price != null) ? fmtUsd(r.suggested_list_price) : "";
        const range = (r?.price_range_low != null && r?.price_range_high != null)
          ? `${fmtUsd(r.price_range_low)}–${fmtUsd(r.price_range_high)}`
          : "";

        const imgSrc = item.image_url || "";

        const div = document.createElement("div");
        div.className = "historyItem";

        div.innerHTML = `
          ${imgSrc
            ? `<img class="thumb" src="${escapeHtml(imgSrc)}" alt="thumb" />`
            : `<div class="thumbPlaceholder">No image</div>`
          }
          <div class="historyMeta">
            <div class="title">${escapeHtml(title)}</div>
            <div>${escapeHtml(range)} ${price ? " • " + escapeHtml(price) : ""}</div>
            <div class="time">${escapeHtml(time)}</div>
            <div class="badge">Shared with your team</div>
          </div>
        `;

        const onSelect = () => {
          teamHistoryEl.querySelectorAll(".historyItem.selected").forEach(el => el.classList.remove("selected"));
          div.classList.add("selected");

          selectedFile = null;
          selectedDataUrl = imgSrc || null;

          if (imgSrc) {
            preview.src = imgSrc;
            preview.style.display = "block";
            previewHint.textContent = "Loaded from team history.";
          } else {
            preview.style.display = "none";
            previewHint.textContent = "Loaded from team history (no image available).";
          }

          statusEl.innerHTML = `<span class="ok">Loaded ✅</span> Loaded from team history.`;
          renderResult(item.result);
          resultEl.scrollIntoView({ behavior: "smooth", block: "start" });
        };

        div.addEventListener("click", onSelect);
        div.addEventListener("touchend", (e) => {
          e.preventDefault();
          onSelect();
        }, { passive: false });

        teamHistoryEl.appendChild(div);
      });
    }

    async function refreshTeamHistory() {
      try {
        const resp = await fetch("/history?limit=25");
        if (resp.status === 401) {
          renderTeamHistory([]);
          return;
        }
        if (!resp.ok) return;
        const data = await resp.json();
        renderTeamHistory(data.items || []);
      } catch (e) {
        console.error(e);
      }
    }

    // =========================
    // File selection
    // =========================
    function openCamera() {
      cameraInput.value = "";
      cameraInput.click();
    }

    function openGallery() {
      galleryInput.value = "";
      galleryInput.click();
    }

    function handleFileSelect(file) {
      if (!file) return;

      selectedFile = file;
      selectedDataUrl = null;

      statusEl.textContent = "";
      resultEl.innerHTML = "";

      analyzeBtn.disabled = true;
      previewHint.textContent = "Loading image…";

      if (lastObjectUrl) URL.revokeObjectURL(lastObjectUrl);
      lastObjectUrl = URL.createObjectURL(file);

      preview.src = lastObjectUrl;
      preview.style.display = "block";

      const reader = new FileReader();
      reader.onload = () => {
        selectedDataUrl = reader.result;
        previewHint.textContent = "Ready to analyze.";
        analyzeBtn.disabled = false;
      };
      reader.onerror = () => {
        previewHint.textContent = "Could not read image.";
        analyzeBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }

    cameraInput.addEventListener("change", () => handleFileSelect(cameraInput.files?.[0]));
    galleryInput.addEventListener("change", () => handleFileSelect(galleryInput.files?.[0]));

    // =========================
    // Analyze
    // =========================
    async function analyze() {
      if (!selectedFile) {
        statusEl.innerHTML = `<span class="err">Select a photo first.</span>`;
        return;
      }
      if (!selectedDataUrl) {
        statusEl.innerHTML = `<span class="err">Please wait—image still loading.</span>`;
        return;
      }

      analyzeBtn.disabled = true;
      statusEl.textContent = "Analyzing…";
      resultEl.innerHTML = "";

      const formData = new FormData();
      // IMPORTANT: backend expects field name "image"
      formData.append("image", selectedFile);

      try {
        const resp = await fetch("/analyze-image", { method: "POST", body: formData });

        if (resp.status === 401) {
          statusEl.innerHTML = `<span class="err">Not logged in.</span> Please refresh the page.`;
          return;
        }

        const payload = await readJsonOrText(resp);

        if (!resp.ok) {
          const msg = payload?.error || payload?.detail || `Server error ${resp.status}`;
          throw new Error(msg);
        }

        statusEl.innerHTML = `<span class="ok">Done ✅</span>`;
        renderResult(payload);

        const r = extractResult(payload);
        if (r && typeof r === "object" && !r.error) {
          // Local history: store results only (NO image) to avoid mobile storage quota
          addToLocalHistory({
            created_at: payload.created_at || nowIso(),
            result: r
          });
        }

        await refreshTeamHistory();
        resultEl.scrollIntoView({ behavior: "smooth", block: "start" });

      } catch (e) {
        console.error(e);
        statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(e.message)}`;
        resultEl.innerHTML = "";
      } finally {
        analyzeBtn.disabled = false;
      }
    }

    // =========================
    // Init
    // =========================
    renderLocalHistory();
    refreshTeamHistory();
  </script>
</body>
</html>
