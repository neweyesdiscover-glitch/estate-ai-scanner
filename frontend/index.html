<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Estate AI Scanner</title>

<style>
  body { font-family: Arial, sans-serif; padding: 16px; max-width: 1100px; margin: 0 auto; }
  h1 { margin: 0 0 6px; }
  .sub { color: #555; margin: 0 0 16px; }

  .controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; align-items: center; }
  button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
  button.primary { background: #2b7cff; color: #fff; border-color: #2b7cff; font-weight: 700; }
  button:disabled { opacity: .6; cursor: not-allowed; }

  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

  .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; background: #fff; }
  .card h3 { margin: 0 0 10px; }

  #previewContainer {
    width: 100%;
    max-height: 420px;
    overflow: hidden;
    border-radius: 10px;
    border: 1px solid #eee;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fafafa;
  }
  #preview { max-width: 100%; max-height: 420px; object-fit: contain; }

  .previewStrip { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
  .previewThumb {
    width: 60px; height: 60px; object-fit: cover;
    border-radius: 8px; border: 2px solid transparent;
    cursor: pointer;
  }
  .previewThumb.active { border-color: #2b7cff; }

  .status { margin-top: 8px; font-size: 14px; }
  .ok { color: #0a7a0a; font-weight: 800; }
  .err { color: #b00020; font-weight: 800; }

  .tipBox {
    margin-top: 14px;
    font-size: 13px;
    background: #f6f6f6;
    padding: 10px;
    border-radius: 10px;
    line-height: 1.35;
  }

  .modeBox {
    display: inline-flex;
    gap: 10px;
    align-items: center;
    border: 1px solid #eee;
    border-radius: 10px;
    padding: 6px 10px;
    background: #fafafa;
    font-size: 13px;
  }

  /* Result cards */
  .resultWrap { display: flex; flex-direction: column; gap: 12px; }
  .itemCard {
    border: 1px solid #eee;
    border-radius: 12px;
    padding: 12px;
    background: #fff;
  }
  .itemTitleRow { display: flex; justify-content: space-between; gap: 10px; align-items: baseline; }
  .itemTitle { font-size: 16px; font-weight: 900; color: #111; }
  .badge {
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid #ddd;
    background: #fafafa;
    color: #333;
    white-space: nowrap;
  }
  .meta { font-size: 13px; color: #444; margin-top: 6px; line-height: 1.35; }
  .meta b { color: #111; }

  .priceRow { margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .priceBox {
    border: 1px solid #eee;
    border-radius: 10px;
    padding: 10px;
    background: #fbfbfb;
  }
  .priceLabel { font-size: 12px; color: #666; margin-bottom: 4px; }
  .priceValue { font-size: 16px; font-weight: 900; color: #111; }

  .notesBox {
    border: 1px dashed #ddd;
    background: #fffdf6;
    padding: 10px;
    border-radius: 10px;
    line-height: 1.35;
  }
  .notesTitle { font-weight: 900; margin-bottom: 4px; }

  details { margin-top: 10px; }
  pre {
    white-space: pre-wrap;
    word-break: break-word;
    background: #f7f7f7;
    border: 1px solid #eee;
    padding: 10px;
    border-radius: 10px;
    margin: 8px 0 0;
    font-size: 12px;
  }
</style>
</head>

<body>

<h1>Estate AI Scanner</h1>
<p class="sub">Snap a photo, identify the item(s), and get an estimate.</p>

<input id="cameraInput" type="file" accept="image/*" capture="environment" hidden />
<input id="galleryInput" type="file" accept="image/*" hidden />
<input id="extraInput" type="file" accept="image/*" multiple hidden />

<div class="controls">
  <button onclick="openCamera()">Use Camera</button>
  <button onclick="openGallery()">Choose From Photos</button>
  <button onclick="addDetail()">Add Detail Photo</button>

  <span class="modeBox">
    <label><input type="radio" name="mode" value="single" checked> Single / Bundle</label>
    <label><input type="radio" name="mode" value="multi"> Multi (max 8)</label>
  </span>

  <button id="analyzeBtn" class="primary" onclick="analyze()">Analyze</button>
</div>

<div class="grid">

  <div class="card">
    <h3>Preview</h3>

    <div id="previewContainer">
      <img id="preview" alt="Preview" />
    </div>

    <div id="previewStrip" class="previewStrip"></div>

    <div class="tipBox">
      <b>Scan tips:</b><br>
      • Add close-up photos of stamps, markings, signatures, or crisp edges.<br>
      • If results are unclear or items are missed, take a brighter and closer photo.<br><br>
      <b>Limits:</b> Max photos per scan: <b>4</b>. Max items in multi-item mode: <b>8</b>.
    </div>
  </div>

  <div class="card">
    <h3>Result</h3>
    <div id="status" class="status"></div>
    <div id="result" class="resultWrap"></div>

    <details>
      <summary>Show raw JSON</summary>
      <pre id="raw"></pre>
    </details>
  </div>

</div>

<script>
  const cameraInput = document.getElementById("cameraInput");
  const galleryInput = document.getElementById("galleryInput");
  const extraInput = document.getElementById("extraInput");

  const preview = document.getElementById("preview");
  const previewStrip = document.getElementById("previewStrip");
  const statusEl = document.getElementById("status");
  const resultEl = document.getElementById("result");
  const rawEl = document.getElementById("raw");
  const analyzeBtn = document.getElementById("analyzeBtn");

  let selectedFiles = [];
  let previewUrls = [];
  let activePreviewIndex = 0;

  function openCamera() { cameraInput.value = ""; cameraInput.click(); }
  function openGallery() { galleryInput.value = ""; galleryInput.click(); }
  function addDetail() { extraInput.value = ""; extraInput.click(); }

  cameraInput.onchange = e => addFiles(e.target.files);
  galleryInput.onchange = e => { clearSelected(); addFiles(e.target.files); };
  extraInput.onchange = e => addFiles(e.target.files);

  function clearSelected() {
    selectedFiles = [];
    previewUrls.forEach(u => URL.revokeObjectURL(u));
    previewUrls = [];
    activePreviewIndex = 0;
    renderPreview();
  }

  function addFiles(files) {
    if (!files || files.length === 0) return;

    for (let file of files) {
      if (selectedFiles.length >= 4) break;
      selectedFiles.push(file);
      previewUrls.push(URL.createObjectURL(file));
    }
    renderPreview();
  }

  function setActivePreview(idx) {
    activePreviewIndex = idx;
    if (previewUrls[idx]) preview.src = previewUrls[idx];
    renderStrip();
  }

  function renderStrip() {
    previewStrip.innerHTML = "";
    previewUrls.forEach((url, i) => {
      const img = document.createElement("img");
      img.src = url;
      img.className = "previewThumb" + (i === activePreviewIndex ? " active" : "");
      img.onclick = () => setActivePreview(i);
      previewStrip.appendChild(img);
    });
  }

  function renderPreview() {
    if (previewUrls.length > 0) preview.src = previewUrls[activePreviewIndex] || previewUrls[0];
    else preview.removeAttribute("src");
    renderStrip();
  }

  async function readJsonOrText(resp) {
    const ct = (resp.headers.get("content-type") || "").toLowerCase();
    const text = await resp.text();
    if (ct.includes("application/json")) {
      try { return JSON.parse(text); }
      catch { return { error: "Invalid JSON response", raw: text }; }
    }
    return { error: "Non-JSON response from server", raw: text };
  }

  function moneyish(v) {
    if (v === null || v === undefined) return "";
    if (typeof v === "number") return `$${v}`;
    const s = String(v).trim();
    if (!s) return "";
    // if already has $ or range, return as-is
    if (s.includes("$")) return s;
    return s;
  }

  function setRaw(payload) {
    rawEl.textContent = JSON.stringify(payload, null, 2);
  }

  function clearResult() {
    resultEl.innerHTML = "";
    setRaw({});
  }

  function renderError(payload, httpStatus) {
    const msg = payload?.error || payload?.detail || "Error";
    statusEl.innerHTML = `<span class="err">${msg}</span>${httpStatus ? ` (HTTP ${httpStatus})` : ""}`;
    resultEl.innerHTML = `
      <div class="notesBox">
        <div class="notesTitle">What happened</div>
        <div>${escapeHtml(payload?.details || payload?.raw || "Please try again.")}</div>
      </div>
    `;
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderStructured(payload) {
    // payload may be {scan_id,...,result:{...}} OR already the result object
    const data = payload?.result ? payload.result : payload;

    const items = Array.isArray(data?.items) ? data.items : [];
    const notes = data?.notes || {};

    // Notes / next best photo
    if (notes?.clarification_request || notes?.suggestions) {
      const clar = notes?.clarification_request ? `<div><b>Next best photo:</b> ${escapeHtml(notes.clarification_request)}</div>` : "";
      const sugg = notes?.suggestions ? `<div style="margin-top:6px;"><b>Tips:</b> ${escapeHtml(notes.suggestions)}</div>` : "";
      const box = document.createElement("div");
      box.className = "notesBox";
      box.innerHTML = `<div class="notesTitle">Improve accuracy</div>${clar}${sugg}`;
      resultEl.appendChild(box);
    }

    if (!items.length) {
      // Fallback: show raw
      const box = document.createElement("div");
      box.className = "notesBox";
      box.innerHTML = `<div class="notesTitle">Result</div><div>No items returned. Check raw JSON below.</div>`;
      resultEl.appendChild(box);
      return;
    }

    items.forEach((it, idx) => {
      const card = document.createElement("div");
      card.className = "itemCard";

      const name = it?.name || it?.title || `Item ${idx + 1}`;
      const author = it?.author ? ` • ${it.author}` : "";
      const condition = it?.condition ? it.condition : (it?.condition_notes || "");
      const cat = it?.category || "";

      const pricing = it?.pricing_estimate || {};
      const indiv = moneyish(pricing?.individual_price ?? it?.suggested_list_price ?? it?.suggested_listing_price);
      const bundle = moneyish(pricing?.bundle_price_range ?? it?.bundle_price_range ?? it?.estimated_value_range);

      card.innerHTML = `
        <div class="itemTitleRow">
          <div class="itemTitle">${escapeHtml(name)}</div>
          <div class="badge">Shared with your team</div>
        </div>

        <div class="meta">
          ${cat ? `<div><b>Category:</b> ${escapeHtml(cat)}</div>` : ""}
          ${condition ? `<div><b>Condition:</b> ${escapeHtml(condition)}</div>` : ""}
          ${author ? `<div><b>Details:</b>${escapeHtml(author)}</div>` : ""}
        </div>

        <div class="priceRow">
          <div class="priceBox">
            <div class="priceLabel">Suggested listing price</div>
            <div class="priceValue">${escapeHtml(indiv || "—")}</div>
          </div>
          <div class="priceBox">
            <div class="priceLabel">Bundle / range</div>
            <div class="priceValue">${escapeHtml(bundle || "—")}</div>
          </div>
        </div>
      `;

      resultEl.appendChild(card);
    });
  }

  async function analyze() {
    if (selectedFiles.length === 0) {
      statusEl.innerHTML = '<span class="err">Select a photo first.</span>';
      return;
    }

    analyzeBtn.disabled = true;
    statusEl.textContent = "Analyzing…";
    clearResult();

    const formData = new FormData();
    selectedFiles.forEach(f => formData.append("images", f));

    const mode = document.querySelector('input[name="mode"]:checked')?.value || "single";
    formData.append("analysis_mode", mode);

    try {
      const resp = await fetch("/analyze-image", { method: "POST", body: formData });
      const payload = await readJsonOrText(resp);
      setRaw(payload);

      if (!resp.ok) {
        renderError(payload, resp.status);
        return;
      }
      if (payload?.error) {
        renderError(payload);
        return;
      }

      statusEl.innerHTML = `<span class="ok">Done ✔</span>`;
      renderStructured(payload);

    } catch (e) {
      renderError({ error: "Network error", details: String(e?.message || e) });
    } finally {
      analyzeBtn.disabled = false;
    }
  }
</script>

</body>
</html>
